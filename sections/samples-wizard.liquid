<section id="samples-wizard" class="section">
  <div class="container layout-constrained">
    <div class="section__header">
      <h2 class="section__title">Free Samples</h2>
    </div>    

    <div id="sw-app">
      <div class="tabs" role="tablist" aria-label="Progress">
        <button aria-selected="true" data-step="1">1. Your details</button>
        <button aria-selected="false" data-step="2">2. Pick samples</button>
        <button aria-selected="false" data-step="3">3. Review & submit</button>
      </div>

      <!-- Step 1 -->
      <article class="card" data-panel="1">
        <div style="display:grid;grid-template-columns:repeat(12,1fr);gap:16px">
          <div style="grid-column:span 6">
            <label>First name*</label>
            <input class="form-input" id="sw-firstname" required>
          </div>
          <div style="grid-column:span 6">
            <label>Last name*</label>
            <input class="form-input" id="sw-lastname" required>
          </div>
          <div style="grid-column:span 6">
            <label>Email*</label>
            <input class="form-input" id="sw-email" type="email" required>
          </div>
          <div style="grid-column:span 6">
            <label>Mobile phone number*</label>
            <input class="form-input" id="sw-mobilephone" required>
          </div>
          <div style="grid-column:span 12">
            <label>Full Street Address*</label>
            <input class="form-input" id="sw-address" required>
          </div>
          <div style="grid-column:span 12">
            <label>Company name*</label>
            <input class="form-input" id="sw-company" required>
          </div>
          <div style="grid-column:span 12">
            <label>Number of Machines*</label>
            <input class="form-input" id="sw-machines" type="number" min="0" required>
          </div>
          <div style="grid-column:span 12">
            <label>Materials Commonly Machined*</label>
            <textarea class="form-input" id="sw-metals_machining" rows="3"></textarea>
          </div>
        </div>
        <div class="w-btn-wrapper">
          <button class="btn btn-primary" id="sw-next-1">Next</button>
        </div>
        <div id="sw-error-1" style="color:#b00020"></div>
      </article>

<!-- Step 2 (PLAIN LIQUID – NO parse_json) -->
<article class="card" data-panel="2" hidden>
  {% assign cat_blocks = 
  "alu_power_endmill|Alu-Power Endmill|alu-power-1-flute-30-helix-end-mill-e5e47|ALU1_ROWS,
   alu_power_endmill|Alu-Power Endmill|alu-power-2-flute-45-helix-long-end-mill-e5522|ALU2_ROWS,
   alu_power_endmill|Alu-Power Endmill|alu-power-3-flute-45-helix-long-end-mill-e5e49|ALU3_ROWS,
   k_2_carbide_endmill|K-2 Carbide Endmill|k-2-carbide-2-flute-30-helix-short-end-mill-g9424|K2_2F_ROWS,
   k_2_carbide_endmill|K-2 Carbide Endmill|k-2-carbide-3-flute-30-helix-short-end-mill-g9425|K2_3F_ROWS,
   k_2_carbide_endmill|K-2 Carbide Endmill|k-2-carbide-4-flute-30-helix-short-end-mill-g9432|K2_4F_ROWS,
   combo_tap|Combo Tap|din371-din376-combo-spiral-flute-bright-tc804|TC804_ROWS,
   combo_tap|Combo Tap|din371-din376-combo-spiral-point-bright-tc814|TC814_ROWS,
   gold_p_jobber_drill|Gold-P Jobber Drill|gold-p-drills-jobber-din338-dlgp195|GOLDP_ROWS,
   iso_inserts|ISO Inserts|tnmg-uf-finishing-turning-insert-60-negative|TNMG_ROWS,
   iso_inserts|ISO Inserts|wnmg-uf-finishing-turning-insert-80-trigonal-negative|WNMG_ROWS,
   iso_inserts|ISO Inserts|cnmg-uf-finishing-turning-insert-80-negative|CNMG_ROWS,
   iso_inserts|ISO Inserts|dnmg-uf-finishing-turning-insert-55-negative|DNMG_ROWS" | split: "," %}

{%- comment -%} ALU-POWER {%- endcomment -%}
{% assign ALU1_ROWS =
  "alu-power-1-flute-30-helix-end-mill-e5e47~3|Ø3.0|Alu-Power 1 Flute | 30° Helix | 3 x 3 x 12 x 50mm (E5E47030),
   alu-power-1-flute-30-helix-end-mill-e5e47~4|Ø4.0|Alu-Power 1 Flute | 30° Helix | 4 x 4 x 15 x 60mm (E5E47040),
   alu-power-1-flute-30-helix-end-mill-e5e47~6|Ø6.0|Alu-Power 1 Flute | 30° Helix | 6 x 6 x 20 x 65mm (E5E47060),
   alu-power-1-flute-30-helix-end-mill-e5e47~8|Ø8.0|Alu-Power 1 Flute | 30° Helix | 8 x 8 x 22 x 65mm (E5E47080)" | split: "," %}

{% assign ALU2_ROWS =
  "alu-power-2-flute-45-helix-long-end-mill-e5522~3|Ø3.0|Alu-Power 2 Flute | 45° Helix | Long | 3 x 6 x 8 x 57mm  (E5522030),
   alu-power-2-flute-45-helix-long-end-mill-e5522~4|Ø4.0|Alu-Power 2 Flute | 45° Helix | Long | 4 x 6 x 11 x 57mm (E5522040),
   alu-power-2-flute-45-helix-long-end-mill-e5522~6|Ø6.0|Alu-Power 2 Flute | 45° Helix | Long | 6 x 6 x 13 x 57mm (E5522060),
   alu-power-2-flute-45-helix-long-end-mill-e5522~8|Ø8.0|Alu-Power 2 Flute | 45° Helix | Long | 8 x 8 x 19 x 63mm (E5522080)" | split: "," %}

{% assign ALU3_ROWS =
  "alu-power-3-flute-45-helix-long-end-mill-e5e49~3|Ø3.0|Alu-Power 3 Flute | 45° Helix | Long | 3 x 6 x 12 x 57mm (E5E49030),
   alu-power-3-flute-45-helix-long-end-mill-e5e49~4|Ø4.0|Alu-Power 3 Flute | 45° Helix | Long | 4 x 6 x 15 x 57mm (E5E49040),
   alu-power-3-flute-45-helix-long-end-mill-e5e49~6|Ø6.0|Alu-Power 3 Flute | 45° Helix | Long | 6 x 6 x 20 x 65mm (E5E49060),
   alu-power-3-flute-45-helix-long-end-mill-e5e49~8|Ø8.0|Alu-Power 3 Flute | 45° Helix | Long | 8 x 8 x 22 x 65mm (E5E49080)" | split: "," %}

{%- comment -%} K-2 CARBIDE {%- endcomment -%}
{% assign K2_2F_ROWS =
  "k-2-carbide-2-flute-30-helix-short-end-mill-g9424~3|Ø3.0|K-2 Carbide 2 Flute | 30° Helix | Short | 3 x 3 x 12 x 32mm (G9424030),
   k-2-carbide-2-flute-30-helix-short-end-mill-g9424~4|Ø4.0|K-2 Carbide 2 Flute | 30° Helix | Short | 4 x 4 x 12 x 40mm (G9424040),
   k-2-carbide-2-flute-30-helix-short-end-mill-g9424~6|Ø6.0|K-2 Carbide 2 Flute | 30° Helix | Short | 6 x 6 x 16 x 50mm (G9424060),
   k-2-carbide-2-flute-30-helix-short-end-mill-g9424~8|Ø8.0|K-2 Carbide 2 Flute | 30° Helix | Short | 8 x 8 x 20 x 60mm (G9424080)" | split: "," %}

{% assign K2_3F_ROWS =
  "k-2-carbide-3-flute-30-helix-short-end-mill-g9425~3|Ø3.0|K-2 Carbide 3 Flute | 30° Helix | Short | 3 x 3 x 12 x 32mm (G9425030),
   k-2-carbide-3-flute-30-helix-short-end-mill-g9425~4|Ø4.0|K-2 Carbide 3 Flute | 30° Helix | Short | 4 x 4 x 12 x 40mm (G9425040),
   k-2-carbide-3-flute-30-helix-short-end-mill-g9425~6|Ø6.0|K-2 Carbide 3 Flute | 30° Helix | Short | 6 x 6 x 16 x 50mm (G9425060),
   k-2-carbide-3-flute-30-helix-short-end-mill-g9425~8|Ø8.0|K-2 Carbide 3 Flute | 30° Helix | Short | 8 x 8 x 20 x 60mm (G9425080)" | split: "," %}

{% assign K2_4F_ROWS =
  "k-2-carbide-4-flute-30-helix-short-end-mill-g9432~3|Ø3.0|K-2 Carbide 4 Flute | 30° Helix | Short | 3 x 3 x 12 x 32mm (G9432030),
   k-2-carbide-4-flute-30-helix-short-end-mill-g9432~4|Ø4.0|K-2 Carbide 4 Flute | 30° Helix | Short | 4 x 4 x 12 x 40mm (G9432040),
   k-2-carbide-4-flute-30-helix-short-end-mill-g9432~6|Ø6.0|K-2 Carbide 4 Flute | 30° Helix | Short | 6 x 6 x 16 x 50mm (G9432060),
   k-2-carbide-4-flute-30-helix-short-end-mill-g9432~8|Ø8.0|K-2 Carbide 4 Flute | 30° Helix | Short | 8 x 8 x 20 x 60mm (G9432080)" | split: "," %}

{%- comment -%} COMBO TAPS {%- endcomment -%}
{% assign TC804_ROWS =
  "din371-din376-combo-spiral-flute-bright-tc804~M4x0.7|M4 x 0.7|HSS-E Combo Tap | DIN371 | Spiral Flute | M4 x 0.7 6H 63.0L (TC804246),
   din371-din376-combo-spiral-flute-bright-tc804~M5x0.8|M5 x 0.8|HSS-E Combo Tap | DIN371 | Spiral Flute | M5 x 0.8 6H 70.0L (TC804286),
   din371-din376-combo-spiral-flute-bright-tc804~M6x1.0|M6 x 1.0|HSS-E Combo Tap | DIN371 | Spiral Flute | M6 x 1.0 6H 80.0L (TC804316),
   din371-din376-combo-spiral-flute-bright-tc804~M8x1.25|M8 x 1.25|HSS-E Combo Tap | DIN371 | Spiral Flute | M8 x 1.25 6H 90.0L (TC804366),
   din371-din376-combo-spiral-flute-bright-tc804~M10x1.5|M10 x 1.5|HSS-E Combo Tap | DIN371 | Spiral Flute | M10 x 1.5 6H 100.0L (TC804426)" | split: "," %}

{% assign TC814_ROWS =
  "din371-din376-combo-spiral-point-bright-tc814~M4x0.7|M4 x 0.7|HSS-E Combo Tap | DIN371 | Gun Point | M4 x 0.7 6H 63.0L (TC814246),
   din371-din376-combo-spiral-point-bright-tc814~M5x0.8|M5 x 0.8|HSS-E Combo Tap | DIN371 | Gun Point | M5 x 0.8 6H 70.0L (TC814286),
   din371-din376-combo-spiral-point-bright-tc814~M6x1.0|M6 x 1.0|HSS-E Combo Tap | DIN371 | Gun Point | M6 x 1.0 6H 80.0L (TC814316),
   din371-din376-combo-spiral-point-bright-tc814~M8x1.25|M8 x 1.25|HSS-E Combo Tap | DIN371 | Gun Point | M8 x 1.25 6H 90.0L (TC814366),
   din371-din376-combo-spiral-point-bright-tc814~M10x1.5|M10 x 1.5|HSS-E Combo Tap | DIN371 | Gun Point | M10 x 1.5 6H 100.0L (TC814426)" | split: "," %}

{%- comment -%} GOLD-P DRILLS {%- endcomment -%}
{% assign GOLDP_ROWS =
  "gold-p-drills-jobber-din338-dlgp195~3.3|Ø3.3|Gold-P Jobber Drill | DIN338/N | 3.3 x 36 x 65mm (DLGP195033),
   gold-p-drills-jobber-din338-dlgp195~4.2|Ø4.2|Gold-P Jobber Drill | DIN338/N | 4.2 x 43 x 75mm (DLGP195042),
   gold-p-drills-jobber-din338-dlgp195~5.0|Ø5.0|Gold-P Jobber Drill | DIN338/N | 5 x 52 x 86mm (DLGP195050),
   gold-p-drills-jobber-din338-dlgp195~6.8|Ø6.8|Gold-P Jobber Drill | DIN338/N | 6.8 x 69 x 109mm (DLGP195068),
   gold-p-drills-jobber-din338-dlgp195~8.5|Ø8.5|Gold-P Jobber Drill | DIN338/N | 8.5 x 75 x 117mm (DLGP195085)" | split: "," %}

{%- comment -%} ISO INSERTS {%- endcomment -%}
{% assign TNMG_ROWS =
  "tnmg-uf-finishing-turning-insert-60-negative~TNMG160404-UF-YG801|TNMG160404-UF / YG801|TNMG160404-UF-YG801/TNMG331-UF (22000039),
   tnmg-uf-finishing-turning-insert-60-negative~TNMG160404-UF-YG3030|TNMG160404-UF / YG3030|TNMG160404-UF-YG3030/TNMG331-UF (22000272),
   tnmg-uf-finishing-turning-insert-60-negative~TNMG160408-UF-YG3020|TNMG160408-UF / YG3020|TNMG160408-UF-YG3020/TNMG332-UF (22000277),
   tnmg-uf-finishing-turning-insert-60-negative~TNMG160408-UF-YG3030|TNMG160408-UF / YG3030|TNMG160408-UF-YG3030/TNMG332-UF (22000278),
   tnmg-uf-finishing-turning-insert-60-negative~TNMG160412-UF-YG3020|TNMG160412-UF / YG3020|TNMG160412-UF-YG3020/TNMG333-UF (22000588)" | split: "," %}

{% assign WNMG_ROWS =
  "wnmg-uf-finishing-turning-insert-80-trigonal-negative~WNMG060404-UF-YG801|WNMG060404-UF / YG801|WNMG060404-UF-YG801/WNMG331-UF (22000058),
   wnmg-uf-finishing-turning-insert-80-trigonal-negative~WNMG060404-UF-YG3030|WNMG060404-UF / YG3030|WNMG060404-UF-YG3030/WNMG331-UF (22000437),
   wnmg-uf-finishing-turning-insert-80-trigonal-negative~WNMG080404-UF-YG801|WNMG080404-UF / YG801|WNMG080404-UF-YG801/WNMG431-UF (22000055),
   wnmg-uf-finishing-turning-insert-80-trigonal-negative~WNMG080404-UF-YG3030|WNMG080404-UF / YG3030|WNMG080404-UF-YG3030/WNMG431-UF (22000317),
   wnmg-uf-finishing-turning-insert-80-trigonal-negative~WNMG080408-UF-YG3020|WNMG080408-UF / YG3020|WNMG080408-UF-YG3020/WNMG432-UF (22000322),
   wnmg-uf-finishing-turning-insert-80-trigonal-negative~WNMG080408-UF-YG3030|WNMG080408-UF / YG3030|WNMG080408-UF-YG3030/WNMG432-UF (22000323)" | split: "," %}

{% assign CNMG_ROWS =
  "cnmg-uf-finishing-turning-insert-80-negative~CNMG120404-UF-YG801|CNMG120404-UF / YG801|CNMG120404-UF-YG801/CNMG431-UF (22000003),
   cnmg-uf-finishing-turning-insert-80-negative~CNMG120404-UF-YG3030|CNMG120404-UF / YG3030|CNMG120404-UF-YG3030/CNMG431-UF (22000180),
   cnmg-uf-finishing-turning-insert-80-negative~CNMG120408-UF-YG3020|CNMG120408-UF / YG3020|CNMG120408-UF-YG3020/CNMG432-UF (22000190),
   cnmg-uf-finishing-turning-insert-80-negative~CNMG120408-UF-YG3030|CNMG120408-UF / YG3030|CNMG120408-UF-YG3030/CNMG432-UF (22000191)" | split: "," %}

{% assign DNMG_ROWS =
  "dnmg-uf-finishing-turning-insert-55-negative~DNMG150404-UF-YG801|DNMG150404-UF / YG801|DNMG150404-UF-YG801/DNMG431-UF (22000016),
   dnmg-uf-finishing-turning-insert-55-negative~DNMG150404-UF-YG3030|DNMG150404-UF / YG3030|DNMG150404-UF-YG3030/DNMG431-UF (22000365),
   dnmg-uf-finishing-turning-insert-55-negative~DNMG150604-UF-YG801|DNMG150604-UF / YG801|DNMG150604-UF-YG801/DNMG441-UF (22000018),
   dnmg-uf-finishing-turning-insert-55-negative~DNMG150604-UF-YG3030|DNMG150604-UF / YG3030|DNMG150604-UF-YG3030/DNMG441-UF (22000227),
   dnmg-uf-finishing-turning-insert-55-negative~DNMG150608-UF-YG3020|DNMG150608-UF / YG3020|DNMG150608-UF-YG3020/DNMG442-UF (22000232),
   dnmg-uf-finishing-turning-insert-55-negative~DNMG150608-UF-YG3030|DNMG150608-UF / YG3030|DNMG150608-UF-YG3030/DNMG442-UF (22000233)" | split: "," %}


  {% for raw in cat_blocks %}
    {% assign parts = raw | strip | split: "|" %}
    {% assign cat_key = parts[0] %}
    {% assign cat_label = parts[1] %}
    {% assign handle = parts[2] %}
    {% assign rows_var = parts[3] %}

    <h3 class="section__title" style="margin:.5rem 0 1rem">{{ cat_label }}</h3>

    {% assign p = all_products[handle] %}
    {% if p %}
      <div class="grid-uniform products-collection rlp_regular" data-category="{{ cat_key }}">
        <div class="sw-card-wrap" data-product-handle="{{ p.handle }}">
          {% render 'product-grid-item-samples', product: p %}

          <div class="card-variants">
            <div class="card-variants-label">Choose option</div>
            <div class="card-variants-chips">
              {% assign rows = nil %}
              {% case rows_var %}
                {% when 'ALU_ROWS' %}{% assign rows = ALU_ROWS %}
                {% when 'K2_ROWS' %}{% assign rows = K2_ROWS %}
                {% when 'COMBO_ROWS' %}{% assign rows = COMBO_ROWS %}
                {% when 'GOLDP_ROWS' %}{% assign rows = GOLDP_ROWS %}
                {% when 'ISO_ROWS' %}{% assign rows = ISO_ROWS %}
              {% endcase %}

              {% for r in rows %}
                {% assign cols = r | strip | split: "|" %}
                {% assign vid  = cols[0] | strip %}
                {% assign lab  = cols[1] | strip %}
                {% assign hs   = cols[2] | strip %}
                {%- assign v = nil -%}

{%- comment %} try numeric where first {%- endcomment -%}
{%- assign wanted_num = vid | plus: 0 -%}
{%- assign v = p.variants | where: 'id', wanted_num | first -%}

{%- if v == nil -%}
  {%- comment %} fallback . compare as strings to avoid type issues {%- endcomment -%}
  {%- assign target = vid | append: '' -%}
  {%- for cand in p.variants -%}
    {%- assign cid = cand.id | append: '' -%}
    {%- if cid == target -%}
      {%- assign v = cand -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

                {% if v %}
                  <button type="button"
                          class="variant-chip sw-select-variant"
                          data-hs-prop="{{ cat_key }}"
                          data-hs-value="{{ hs | escape }}"
                          data-variant-id="{{ v.id }}"
                          data-variant-sku="{{ v.sku | escape }}">
                    {{ lab }}
                  </button>
                {% else %}
                  <span class="variant-chip variant-chip--more">Missing variant {{ lab }}</span>
                {% endif %}
              {% endfor %}
            </div>
          </div>

          <div class="w-btn-wrapper">
            <button class="btn btn-outline sw-select-btn" data-category="{{ cat_key }}">Confirm selection</button>
          </div>
        </div>
      </div>
    {% else %}
      <div class="card">Missing product handle: <code>{{ handle }}</code></div>
    {% endif %}
  {% endfor %}

  <div class="w-btn-wrapper" style="display:flex;gap:12px">
    <button class="btn btn-outline" id="sw-back-2">Back</button>
    <button class="btn btn-primary" id="sw-next-2">Review</button>
  </div>
</article>


      <!-- Step 3 -->
      <article class="card" data-panel="3" hidden>
        <h3 class="section__title">Review</h3>
        <div id="sw-review"></div>
        <div class="w-btn-wrapper">
          <button class="btn btn-outline" id="sw-back-3">Back</button>
          <button class="btn btn-primary full-width" id="sw-submit">Send me samples</button>
        </div>
        <div id="sw-error-3" style="color:#b00020"></div>
        <div id="sw-success" class="card" style="display:none;background:#ecfdf5;border-color:#10b981;color:#064e3b">
          Thanks. we’ve got it.
        </div>
      </article>
    </div>
  </div>

  <script>
  (function(){
    const HUBSPOT = {
      portalId: "2595431",
      formGuid: "30c37b27-b6db-444a-9872-19ddb7e78b89",
      workerEndpoint: "https://samples-hs-submit.marketingexcision.workers.dev/",
      redirectUrl: "/pages/thank-you"
    };

    const FIELD_MAP = {
      firstname: "firstname",
      lastname: "lastname",
      email: "email",
      mobilephone: "mobilephone",
      address: "address",
      company: "company",
      machines: "machines",
      metals_machining: "metals_machining",
      products: {
        alu_power_endmill: "alu_power_endmill",
        k_2_carbide_endmill: "k_2_carbide_endmill",
        combo_tap: "combo_tap",
        gold_p_jobber_drill: "gold_p_jobber_drill",
        iso_inserts: "iso_inserts"
      }
    };

    const state = { step:1, contact:{}, selections:{} };
    const $ = s => document.querySelector(s);
    const $$ = (s,root=document) => Array.from(root.querySelectorAll(s));

    function setStep(n){
      state.step = n;
      $$('.tabs button').forEach((b,i)=> b.setAttribute('aria-selected', String(i+1===n)));
      $$('article.card[data-panel]').forEach(p => p.hidden = (Number(p.dataset.panel)!==n));
      if(n===3) renderReview();
    }

    $('#sw-next-1').addEventListener('click', () => {
      const get = id => $(id).value.trim();
      const req = ['#sw-firstname','#sw-lastname','#sw-email','#sw-mobilephone','#sw-address','#sw-company','#sw-machines'];
      if(req.some(sel => !$(sel).value.trim())){ $('#sw-error-1').textContent='Fill the required fields first.'; return; }
      $('#sw-error-1').textContent='';
      state.contact = {
        firstname: get('#sw-firstname'), lastname: get('#sw-lastname'), email: get('#sw-email'),
        mobilephone: get('#sw-mobilephone'), address: get('#sw-address'), company: get('#sw-company'),
        machines: get('#sw-machines'), metals_machining: get('#sw-metals_machining')
      };
      setStep(2);
    });

    $('#sw-back-2').addEventListener('click', ()=> setStep(1));
    $('#sw-next-2').addEventListener('click', ()=> setStep(3));
    $('#sw-back-3').addEventListener('click', ()=> setStep(2));

     // state.selections[cat] = { variantId, sku, hsValue }
  const catSections = document.querySelectorAll('.grid-uniform.products-collection');

  catSections.forEach(section => {
    const cat = section.dataset.category;

    // choose a chip
    section.addEventListener('click', e => {
      const chip = e.target.closest('.sw-select-variant');
      if (!chip) return;

      // set active visual within the same card
      const wrap = chip.closest('.sw-card-wrap');
      wrap.querySelectorAll('.sw-select-variant').forEach(c => c.classList.remove('is-active'));
      chip.classList.add('is-active');

      // stash the pending pick on the card
      wrap.dataset.pendingVariantId = chip.dataset.variantId;
      wrap.dataset.pendingSku = chip.dataset.variantSku || '';
      wrap.dataset.pendingHsValue = chip.dataset.hsValue;
    });

    // confirm selection for the category
    section.addEventListener('click', e => {
      const btn = e.target.closest('.sw-select-btn');
      if (!btn) return;

      const wrap = btn.closest('.sw-card-wrap');
      const vid = wrap.dataset.pendingVariantId;
      const hsValue = wrap.dataset.pendingHsValue;

      if (!vid || !hsValue) {
        alert('Pick a variant first.');
        return;
      }

      // lock this selection at category level
      state.selections[cat] = {
        variantId: vid,
        sku: wrap.dataset.pendingSku || '',
        value: hsValue
      };

      // highlight the chosen card for the category
      section.querySelectorAll('.sw-card-wrap').forEach(w => w.style.outline='none');
      wrap.style.outline = '2px solid var(--color-primary-blue)';
    });
  });

    function renderReview(){
      const c = state.contact, s = state.selections;
      $('#sw-review').innerHTML = `
        <div><strong>Contact</strong><br>
        ${c.firstname||''} ${c.lastname||''} · ${c.email||''}<br>
        ${c.mobilephone||''} · ${c.address||''}<br>
        ${c.company||''} · Machines: ${c.machines||''}<br>
        Materials: ${c.metals_machining||''}</div>
        <hr style="margin:12px 0">
        <div><strong>Samples</strong><ul style="margin:.5rem 0">
          ${Object.entries(FIELD_MAP.products).map(([k,_]) => {
            const v = s[k]?.value || '—';
            const label = k.replaceAll('_',' ').replace('k 2','K-2');
            return `<li>${label}: ${v}</li>`;
          }).join('')}
        </ul></div>`;
    }

    function buildPayload(){
      const fields = [];
      const c = state.contact;
      Object.keys(FIELD_MAP).forEach(k=>{
        if(k==='products') return;
        fields.push({ name: FIELD_MAP[k], value: String(c[k]||'') });
      });
      Object.entries(FIELD_MAP.products).forEach(([cat, prop])=>{
        const val = state.selections[cat]?.value || '';
        fields.push({ name: prop, value: val });
      });
      const hutk = document.cookie.split('; ').find(c=>c.startsWith('hubspotutk='))?.split('=')[1];
      return {
        portalId: HUBSPOT.portalId,
        formGuid: HUBSPOT.formGuid,
        fields,
        context: { hutk, pageUri: location.href, pageName: document.title }
      };
    }

    $('#sw-submit').addEventListener('click', async ()=>{
      try{
        $('#sw-error-3').textContent = '';
        const res = await fetch(HUBSPOT.workerEndpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(buildPayload()) });
        if(!res.ok) throw new Error(await res.text());
        $('#sw-success').style.display='block';
        if(HUBSPOT.redirectUrl) setTimeout(()=> location.href=HUBSPOT.redirectUrl, 900);
      }catch(err){
        $('#sw-error-3').textContent = 'Submission failed: ' + (err.message||err);
      }
    });

    setStep(1);
  })();
  </script>
</section>

<style>
  .sw-select-variant.is-active {
    border-color: var(--color-primary-blue);
    box-shadow: 0 0 0 2px rgba(0,105,167,.12);
  }
</style>


{% schema %}
{
  "name": "Samples Wizard",
  "settings": [
    { "type":"collection", "id":"alu_power_endmill", "label":"Alu-Power Endmill collection" },
    { "type":"collection", "id":"k_2_carbide_endmill", "label":"K-2 Carbide Endmill collection" },
    { "type":"collection", "id":"combo_tap", "label":"Combo Tap collection" },
    { "type":"collection", "id":"gold_p_jobber_drill", "label":"Gold-P Jobber Drill collection" },
    { "type":"collection", "id":"iso_inserts", "label":"ISO Inserts collection" }
  ],
  "presets": [{ "name":"Samples Wizard" }]
}
{% endschema %}

