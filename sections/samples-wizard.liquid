{% comment %}
Samples Wizard – stepper + product selection + HubSpot submit via Cloudflare Worker
{% endcomment %}

{%- capture _hard_catalog_json -%}
{
  "alu_power_endmill": [
    {
      "handle": "alu-power-1-flute-30-helix-end-mill-e5e47",
      "variants": [
        { "id": 47931053801701, "label": "Ø3.0",  "hs_value": "Alu-Power 1 Flute | 30° Helix | 3 x 3 x 12 x 50mm (E5E47030)" },
        { "id": 47931053834469, "label": "Ø4.0",  "hs_value": "Alu-Power 1 Flute | 30° Helix | 4 x 4 x 15 x 60mm (E5E47040)" },
        { "id": 47931053900005, "label": "Ø6.0",  "hs_value": "Alu-Power 1 Flute | 30° Helix | 6 x 6 x 20 x 65mm (E5E47060)" },
        { "id": 47931053932773, "label": "Ø8.0",  "hs_value": "Alu-Power 1 Flute | 30° Helix | 8 x 8 x 22 x 65mm (E5E47080)" }
      ]
    }
  ],
  "k_2_carbide_endmill": [
    {
      "handle": "k2-carbide-endmill",
      "variants": [
        { "id": 55555555555555, "label": "Ø3.0",  "hs_value": "K-2 Carbide 2 Flute | 30° | Short | 3 x 3 x 12 x 32mm (G9424030)" },
        { "id": 66666666666666, "label": "Ø6.0",  "hs_value": "K-2 Carbide 4 Flute | 30° | Short | 6 x 6 x 16 x 50mm (G9432060)" },
        { "id": 77777777777777, "label": "Ø8.0",  "hs_value": "K-2 Carbide 4 Flute | 30° | Short | 8 x 8 x 20 x 60mm (G9432080)" }
      ]
    }
  ],
  "combo_tap": [
    {
      "handle": "hss-e-combo-tap",
      "variants": [
        { "id": 88888888888888, "label": "M4 x 0.7",  "hs_value": "HSS-E Combo Tap | DIN371 | Spiral Flute | M4 x 0.7 6H 63.0L (TC804246)" },
        { "id": 99999999999999, "label": "M8 x 1.25", "hs_value": "HSS-E Combo Tap | DIN371 | Gun Point | M8 x 1.25 6H 90.0L (TC814366)" }
      ]
    }
  ],
  "gold_p_jobber_drill": [
    {
      "handle": "gold-p-jobber-drill",
      "variants": [
        { "id": 12312312312312, "label": "Ø3.3", "hs_value": "Gold-P Jobber Drill | DIN338/N | 3.3 x 36 x 65mm (DLGP195033)" },
        { "id": 12412412412412, "label": "Ø6.8", "hs_value": "Gold-P Jobber Drill | DIN338/N | 6.8 x 69 x 109mm (DLGP195068)" }
      ]
    }
  ],
  "iso_inserts": [
    {
      "handle": "dnmg-insert",
      "variants": [
        { "id": 13513513513513, "label": "DNMG150604-UF-YG3030", "hs_value": "DNMG150604-UF-YG3030/DNMG441-UF (22000227)" }
      ]
    }
  ]
}
{%- endcapture -%}
{%- assign hard_catalog = _hard_catalog_json | strip | parse_json -%}



<section id="samples-wizard" class="section">
  <div class="container layout-constrained">
    <div class="section__header">
      <h2 class="section__title">Free Samples</h2>
    </div>    

    <div id="sw-app">
      <div class="tabs" role="tablist" aria-label="Progress">
        <button aria-selected="true" data-step="1">1. Your details</button>
        <button aria-selected="false" data-step="2">2. Pick samples</button>
        <button aria-selected="false" data-step="3">3. Review & submit</button>
      </div>

      <!-- Step 1 -->
      <article class="card" data-panel="1">
        <div style="display:grid;grid-template-columns:repeat(12,1fr);gap:16px">
          <div style="grid-column:span 6">
            <label>First name*</label>
            <input class="form-input" id="sw-firstname" required>
          </div>
          <div style="grid-column:span 6">
            <label>Last name*</label>
            <input class="form-input" id="sw-lastname" required>
          </div>
          <div style="grid-column:span 6">
            <label>Email*</label>
            <input class="form-input" id="sw-email" type="email" required>
          </div>
          <div style="grid-column:span 6">
            <label>Mobile phone number*</label>
            <input class="form-input" id="sw-mobilephone" required>
          </div>
          <div style="grid-column:span 12">
            <label>Full Street Address*</label>
            <input class="form-input" id="sw-address" required>
          </div>
          <div style="grid-column:span 12">
            <label>Company name*</label>
            <input class="form-input" id="sw-company" required>
          </div>
          <div style="grid-column:span 12">
            <label>Number of Machines*</label>
            <input class="form-input" id="sw-machines" type="number" min="0" required>
          </div>
          <div style="grid-column:span 12">
            <label>Materials Commonly Machined*</label>
            <textarea class="form-input" id="sw-metals_machining" rows="3"></textarea>
          </div>
        </div>
        <div class="w-btn-wrapper">
          <button class="btn btn-primary" id="sw-next-1">Next</button>
        </div>
        <div id="sw-error-1" style="color:#b00020"></div>
      </article>

<!-- Step 2 (HARDCODED + VARIANTS) -->
<article class="card" data-panel="2" hidden>
  {% assign cat_keys = "alu_power_endmill|k_2_carbide_endmill|combo_tap|gold_p_jobber_drill|iso_inserts" | split: "|" %}
  {% assign cat_labels = 
    '{
      "alu_power_endmill":"Alu-Power Endmill",
      "k_2_carbide_endmill":"K-2 Carbide Endmill",
      "combo_tap":"Combo Tap",
      "gold_p_jobber_drill":"Gold-P Jobber Drill",
      "iso_inserts":"ISO Inserts"
    }' | parse_json
  %}

  {% for cat_key in cat_keys %}
    <h3 class="section__title" style="margin:.5rem 0 1rem">{{ cat_labels[cat_key] }}</h3>

    <div class="grid-uniform products-collection rlp_regular" data-category="{{ cat_key }}">
      {% assign entries = hard_catalog[cat_key] %}
      {% if entries and entries.size > 0 %}
        {% for entry in entries %}

            <p style="font-size:12px;opacity:.7">
  Test: {{ all_products['alu-power-1-flute-30-helix-end-mill-e5e47'] | default: 'NO PRODUCT FOR THAT HANDLE' | json }}
</p>


          {% assign p = all_products[entry.handle] %}

          {% if p %}
            <div class="sw-card-wrap" data-product-handle="{{ p.handle }}">
              {% render 'product-grid-item', product: p %}  {# pass product explicitly #}

              <div class="card-variants">
                <div class="card-variants-label">Choose variant</div>
                <div class="card-variants-chips">
                  {% for vdef in entry.variants %}
                    {% assign v = p.variants | where: 'id', vdef.id | first %}
                    {% if v %}
                      <button type="button"
                              class="variant-chip sw-select-variant"
                              data-hs-prop="{{ cat_key }}"
                              data-hs-value="{{ vdef.hs_value | escape }}"
                              data-variant-id="{{ v.id }}"
                              data-variant-sku="{{ v.sku | escape }}">
                        {{ vdef.label }}
                      </button>
                    {% else %}
                      <span class="variant-chip variant-chip--more">Missing variant {{ vdef.label }}</span>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>

              <div class="w-btn-wrapper">
                <button class="btn btn-outline sw-select-btn" data-category="{{ cat_key }}">Confirm selection</button>
              </div>
            </div>
          {% else %}
            <div class="sw-card-wrap">
              <div class="card">Missing product handle: <code>{{ entry.handle }}</code></div>
            </div>
          {% endif %}
        {% endfor %}
      {% else %}
        <div class="card">No entries for {{ cat_labels[cat_key] }}</div>
      {% endif %}
    </div>
  {% endfor %}

  <div class="w-btn-wrapper" style="display:flex;gap:12px">
    <button class="btn btn-outline" id="sw-back-2">Back</button>
    <button class="btn btn-primary" id="sw-next-2">Review</button>
  </div>
</article>



      <!-- Step 3 -->
      <article class="card" data-panel="3" hidden>
        <h3 class="section__title">Review</h3>
        <div id="sw-review"></div>
        <div class="w-btn-wrapper">
          <button class="btn btn-outline" id="sw-back-3">Back</button>
          <button class="btn btn-primary full-width" id="sw-submit">Send me samples</button>
        </div>
        <div id="sw-error-3" style="color:#b00020"></div>
        <div id="sw-success" class="card" style="display:none;background:#ecfdf5;border-color:#10b981;color:#064e3b">
          Thanks. we’ve got it.
        </div>
      </article>
    </div>
  </div>

  <script>
  (function(){
    const HUBSPOT = {
      portalId: "2595431",
      formGuid: "30c37b27-b6db-444a-9872-19ddb7e78b89",
      workerEndpoint: "https://samples-hs-submit.marketingexcision.workers.dev/",
      redirectUrl: "/pages/thank-you"
    };

    const FIELD_MAP = {
      firstname: "firstname",
      lastname: "lastname",
      email: "email",
      mobilephone: "mobilephone",
      address: "address",
      company: "company",
      machines: "machines",
      metals_machining: "metals_machining",
      products: {
        alu_power_endmill: "alu_power_endmill",
        k_2_carbide_endmill: "k_2_carbide_endmill",
        combo_tap: "combo_tap",
        gold_p_jobber_drill: "gold_p_jobber_drill",
        iso_inserts: "iso_inserts"
      }
    };

    const state = { step:1, contact:{}, selections:{} };
    const $ = s => document.querySelector(s);
    const $$ = (s,root=document) => Array.from(root.querySelectorAll(s));

    function setStep(n){
      state.step = n;
      $$('.tabs button').forEach((b,i)=> b.setAttribute('aria-selected', String(i+1===n)));
      $$('article.card[data-panel]').forEach(p => p.hidden = (Number(p.dataset.panel)!==n));
      if(n===3) renderReview();
    }

    $('#sw-next-1').addEventListener('click', () => {
      const get = id => $(id).value.trim();
      const req = ['#sw-firstname','#sw-lastname','#sw-email','#sw-mobilephone','#sw-address','#sw-company','#sw-machines'];
      if(req.some(sel => !$(sel).value.trim())){ $('#sw-error-1').textContent='Fill the required fields first.'; return; }
      $('#sw-error-1').textContent='';
      state.contact = {
        firstname: get('#sw-firstname'), lastname: get('#sw-lastname'), email: get('#sw-email'),
        mobilephone: get('#sw-mobilephone'), address: get('#sw-address'), company: get('#sw-company'),
        machines: get('#sw-machines'), metals_machining: get('#sw-metals_machining')
      };
      setStep(2);
    });

    $('#sw-back-2').addEventListener('click', ()=> setStep(1));
    $('#sw-next-2').addEventListener('click', ()=> setStep(3));
    $('#sw-back-3').addEventListener('click', ()=> setStep(2));

     // state.selections[cat] = { variantId, sku, hsValue }
  const catSections = document.querySelectorAll('.grid-uniform.products-collection');

  catSections.forEach(section => {
    const cat = section.dataset.category;

    // choose a chip
    section.addEventListener('click', e => {
      const chip = e.target.closest('.sw-select-variant');
      if (!chip) return;

      // set active visual within the same card
      const wrap = chip.closest('.sw-card-wrap');
      wrap.querySelectorAll('.sw-select-variant').forEach(c => c.classList.remove('is-active'));
      chip.classList.add('is-active');

      // stash the pending pick on the card
      wrap.dataset.pendingVariantId = chip.dataset.variantId;
      wrap.dataset.pendingSku = chip.dataset.variantSku || '';
      wrap.dataset.pendingHsValue = chip.dataset.hsValue;
    });

    // confirm selection for the category
    section.addEventListener('click', e => {
      const btn = e.target.closest('.sw-select-btn');
      if (!btn) return;

      const wrap = btn.closest('.sw-card-wrap');
      const vid = wrap.dataset.pendingVariantId;
      const hsValue = wrap.dataset.pendingHsValue;

      if (!vid || !hsValue) {
        alert('Pick a variant first.');
        return;
      }

      // lock this selection at category level
      state.selections[cat] = {
        variantId: vid,
        sku: wrap.dataset.pendingSku || '',
        value: hsValue
      };

      // highlight the chosen card for the category
      section.querySelectorAll('.sw-card-wrap').forEach(w => w.style.outline='none');
      wrap.style.outline = '2px solid var(--color-primary-blue)';
    });
  });

    function renderReview(){
      const c = state.contact, s = state.selections;
      $('#sw-review').innerHTML = `
        <div><strong>Contact</strong><br>
        ${c.firstname||''} ${c.lastname||''} · ${c.email||''}<br>
        ${c.mobilephone||''} · ${c.address||''}<br>
        ${c.company||''} · Machines: ${c.machines||''}<br>
        Materials: ${c.metals_machining||''}</div>
        <hr style="margin:12px 0">
        <div><strong>Samples</strong><ul style="margin:.5rem 0">
          ${Object.entries(FIELD_MAP.products).map(([k,_]) => {
            const v = s[k]?.value || '—';
            const label = k.replaceAll('_',' ').replace('k 2','K-2');
            return `<li>${label}: ${v}</li>`;
          }).join('')}
        </ul></div>`;
    }

    function buildPayload(){
      const fields = [];
      const c = state.contact;
      Object.keys(FIELD_MAP).forEach(k=>{
        if(k==='products') return;
        fields.push({ name: FIELD_MAP[k], value: String(c[k]||'') });
      });
      Object.entries(FIELD_MAP.products).forEach(([cat, prop])=>{
        const val = state.selections[cat]?.value || '';
        fields.push({ name: prop, value: val });
      });
      const hutk = document.cookie.split('; ').find(c=>c.startsWith('hubspotutk='))?.split('=')[1];
      return {
        portalId: HUBSPOT.portalId,
        formGuid: HUBSPOT.formGuid,
        fields,
        context: { hutk, pageUri: location.href, pageName: document.title }
      };
    }

    $('#sw-submit').addEventListener('click', async ()=>{
      try{
        $('#sw-error-3').textContent = '';
        const res = await fetch(HUBSPOT.workerEndpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(buildPayload()) });
        if(!res.ok) throw new Error(await res.text());
        $('#sw-success').style.display='block';
        if(HUBSPOT.redirectUrl) setTimeout(()=> location.href=HUBSPOT.redirectUrl, 900);
      }catch(err){
        $('#sw-error-3').textContent = 'Submission failed: ' + (err.message||err);
      }
    });

    setStep(1);
  })();
  </script>
</section>

<style>
  .sw-select-variant.is-active {
    border-color: var(--color-primary-blue);
    box-shadow: 0 0 0 2px rgba(0,105,167,.12);
  }
</style>


{% schema %}
{
  "name": "Samples Wizard",
  "settings": [
    { "type":"collection", "id":"alu_power_endmill", "label":"Alu-Power Endmill collection" },
    { "type":"collection", "id":"k_2_carbide_endmill", "label":"K-2 Carbide Endmill collection" },
    { "type":"collection", "id":"combo_tap", "label":"Combo Tap collection" },
    { "type":"collection", "id":"gold_p_jobber_drill", "label":"Gold-P Jobber Drill collection" },
    { "type":"collection", "id":"iso_inserts", "label":"ISO Inserts collection" }
  ],
  "presets": [{ "name":"Samples Wizard" }]
}
{% endschema %}

