{% comment %}
Samples Wizard – stepper + product selection + HubSpot submit via Worker
Settings:
- pick a collection for each category (we render using 'product-grid-item')
- configure Worker endpoint + thank-you URL
{% endcomment %}

<section id="samples-wizard" class="section">
  <div class="container layout-constrained">
    <div class="section__header">
      <h2 class="section__title">Free Samples</h2>
    </div>

    <div id="sw-app">
      <div class="tabs" role="tablist" aria-label="Progress">
        <button aria-selected="true" data-step="1">1. Your details</button>
        <button aria-selected="false" data-step="2">2. Pick samples</button>
        <button aria-selected="false" data-step="3">3. Review & submit</button>
      </div>

      <!-- Step 1 -->
      <article class="card" data-panel="1">
        <div class="grid" style="display:grid;grid-template-columns:repeat(12,1fr);gap:16px">
          <div style="grid-column:span 6">
            <label>First name*</label>
            <input class="form-input" id="sw-firstname" required>
          </div>
          <div style="grid-column:span 6">
            <label>Last name*</label>
            <input class="form-input" id="sw-lastname" required>
          </div>
          <div style="grid-column:span 6">
            <label>Email*</label>
            <input class="form-input" id="sw-email" type="email" required>
          </div>
          <div style="grid-column:span 6">
            <label>Mobile phone number*</label>
            <input class="form-input" id="sw-mobilephone" required>
          </div>
          <div style="grid-column:span 12">
            <label>Full Street Address*</label>
            <input class="form-input" id="sw-address" required>
          </div>
          <div style="grid-column:span 12">
            <label>Company name*</label>
            <input class="form-input" id="sw-company" required>
          </div>
          <div style="grid-column:span 12">
            <label>Number of Machines*</label>
            <input class="form-input" id="sw-machines" type="number" min="0" required>
          </div>
          <div style="grid-column:span 12">
            <label>Materials Commonly Machined*</label>
            <textarea class="form-input" id="sw-metals_machining" rows="3"></textarea>
          </div>
        </div>
        <div class="w-btn-wrapper">
          <button class="btn btn-primary" id="sw-next-1">Next</button>
        </div>
        <div id="sw-error-1" style="color:#b00020"></div>
      </article>

      <!-- Step 2 -->
      <article class="card" data-panel="2" hidden>
        {% assign cats = 
          '{ 
            "alu_power_endmill": "Alu-Power Endmill",
            "k_2_carbide_endmill": "K-2 Carbide Endmill",
            "combo_tap": "Combo Tap",
            "gold_p_jobber_drill": "Gold-P Jobber Drill",
            "iso_inserts": "ISO Inserts"
          }' | parse_json %}

        {% for key in cats %}
          {% assign handle = section.settings[key[0]] %}
          {% if handle %}
            {% assign catCollection = collections[handle] %}
            <h3 class="section__title" style="margin:.5rem 0 1rem">{{ key[1] }}</h3>
            <div class="grid-uniform products-collection rlp_regular" data-category="{{ key[0] }}">
              {% for product in catCollection.products %}
                {% assign first_variant = product.selected_or_first_available_variant %}
                {% comment %} Your shop snippet renders card UI {% endcomment %}
                <div class="sw-card-wrap" data-product-title="{{ product.title | escape }}" data-variant-sku="{{ first_variant.sku | escape }}">
                  {% include 'product-grid-item' %}
                  <div class="w-btn-wrapper">
                    <button class="btn btn-outline sw-select-btn">Select sample</button>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endfor %}

        <div class="w-btn-wrapper" style="display:flex;gap:12px">
          <button class="btn btn-outline" id="sw-back-2">Back</button>
          <button class="btn btn-primary" id="sw-next-2">Review</button>
        </div>
      </article>

      <!-- Step 3 -->
      <article class="card" data-panel="3" hidden>
        <h3 class="section__title">Review</h3>
        <div id="sw-review"></div>
        <div class="w-btn-wrapper">
          <button class="btn btn-outline" id="sw-back-3">Back</button>
          <button class="btn btn-primary full-width" id="sw-submit">Send me samples</button>
        </div>
        <div id="sw-error-3" style="color:#b00020"></div>
        <div id="sw-success" class="card" style="display:none;background:#ecfdf5;border-color:#10b981;color:#064e3b">
          Thanks. we’ve got it.
        </div>
      </article>
    </div>
  </div>

  <script>
  (function(){
    const HUBSPOT = {
      portalId: "2595431",
      formGuid: "30c37b27-b6db-444a-9872-19ddb7e78b89",
      workerEndpoint: "{{ section.settings.worker_endpoint | escape }}",
      redirectUrl: "{{ section.settings.thankyou_url | escape }}"
    };

    const FIELD_MAP = {
      firstname: "firstname",
      lastname: "lastname",
      email: "email",
      mobilephone: "mobilephone",
      address: "address",
      company: "company",
      machines: "machines",
      metals_machining: "metals_machining",
      products: {
        alu_power_endmill: "alu_power_endmill",
        k_2_carbide_endmill: "k_2_carbide_endmill",
        combo_tap: "combo_tap",
        gold_p_jobber_drill: "gold_p_jobber_drill",
        iso_inserts: "iso_inserts"
      }
    };

    const state = { step:1, contact:{}, selections:{} };
    const $ = s => document.querySelector(s);
    const $$ = (s,root=document) => Array.from(root.querySelectorAll(s));

    // Stepper
    function setStep(n){
      state.step = n;
      $$('.tabs button').forEach((b,i)=> b.setAttribute('aria-selected', String(i+1===n)));
      $$('article.card[data-panel]').forEach(p => p.hidden = (Number(p.dataset.panel)!==n));
      if(n===3) renderReview();
    }

    $('#sw-next-1').addEventListener('click', () => {
      const get = id => $(id).value.trim();
      const req = ['#sw-firstname','#sw-lastname','#sw-email','#sw-mobilephone','#sw-address','#sw-company','#sw-machines'];
      if(req.some(sel => !$(sel).value.trim())){ $('#sw-error-1').textContent='Fill the required fields first.'; return; }
      $('#sw-error-1').textContent='';
      state.contact = {
        firstname: get('#sw-firstname'), lastname: get('#sw-lastname'), email: get('#sw-email'),
        mobilephone: get('#sw-mobilephone'), address: get('#sw-address'), company: get('#sw-company'),
        machines: get('#sw-machines'), metals_machining: get('#sw-metals_machining')
      };
      setStep(2);
    });

    $('#sw-back-2').addEventListener('click', ()=> setStep(1));
    $('#sw-next-2').addEventListener('click', ()=> setStep(3));
    $('#sw-back-3').addEventListener('click', ()=> setStep(2));

    // Selection via product-grid-item wrappers
    $$('.grid-uniform.products-collection').forEach(section => {
      section.addEventListener('click', (e)=>{
        const btn = e.target.closest('.sw-select-btn');
        if(!btn) return;
        const wrap = e.target.closest('.sw-card-wrap');
        const category = section.dataset.category;
        const title = wrap.dataset.productTitle;
        const sku = wrap.dataset.variantSku || '';
        state.selections[category] = { title, sku, value: `${title}${sku ? ' ('+sku+')' : ''}` };
        // Visual: mark selected card
        $$('.sw-card-wrap', section).forEach(w => w.style.outline='none');
        wrap.style.outline = '2px solid var(--color-primary-blue)';
      });
    });

    function renderReview(){
      const c = state.contact;
      const s = state.selections;
      $('#sw-review').innerHTML = `
        <div><strong>Contact</strong><br>
        ${c.firstname||''} ${c.lastname||''} · ${c.email||''}<br>
        ${c.mobilephone||''} · ${c.address||''}<br>
        ${c.company||''} · Machines: ${c.machines||''}<br>
        Materials: ${c.metals_machining||''}</div>
        <hr style="margin:12px 0">
        <div><strong>Samples</strong><ul style="margin:.5rem 0">
          ${Object.keys(FIELD_MAP.products).map(k => {
            const v = s[k]?.value || '—';
            const label = k.replaceAll('_',' ').replace('k 2','K-2');
            return `<li>${label}: ${v}</li>`;
          }).join('')}
        </ul></div>`;
    }

    function buildPayload(){
      const fields = [];
      const c = state.contact;
      Object.keys(FIELD_MAP).forEach(k=>{
        if(k==='products') return;
        fields.push({ name: FIELD_MAP[k], value: String(c[k]||'') });
      });
      // product selections
      Object.entries(FIELD_MAP.products).forEach(([cat, prop])=>{
        const val = state.selections[cat]?.value || '';
        fields.push({ name: prop, value: val });
      });
      const hutk = document.cookie.split('; ').find(c=>c.startsWith('hubspotutk='))?.split('=')[1];
      return {
        portalId: HUBSPOT.portalId,
        formGuid: HUBSPOT.formGuid,
        fields,
        context: { hutk, pageUri: location.href, pageName: document.title }
      };
    }

    $('#sw-submit').addEventListener('click', async ()=>{
      try{
        $('#sw-error-3').textContent = '';
        const payload = buildPayload();
        const res = await fetch(HUBSPOT.workerEndpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if(!res.ok) throw new Error(await res.text());
        $('#sw-success').style.display='block';
        if(HUBSPOT.redirectUrl) setTimeout(()=> location.href=HUBSPOT.redirectUrl, 900);
      }catch(err){
        $('#sw-error-3').textContent = 'Submission failed: ' + (err.message||err);
      }
    });

    setStep(1);
  })();
  </script>
</section>
