{% assign lengths = "Throw Away|Stub|Short|Long|Extra Long|Long Reach|Extended Neck" | split: "|" %}
{% assign types   = "Center Match|Rib Processing|Miniature|High Feed|Sharp Corner Removal|Taper Neck|Center Cut" | split: "|" %}


<section
  class="section"
  id="endmill-selector"
  data-section-id="{{ section.id }}"
  data-collection="{{ section.settings.collection | default: blank }}"
>
  <div class="container layout-constrained">
    <header class="section__header">
      <h2 class="section__title h2">Find the right endmill</h2>
      <p class="section__intro">Answer four quick questions. We’ll show endmills that match.</p>
    </header>

    <!-- Progress -->
    <div class="w-btn-wrapper" style="display:flex;gap:10px;align-items:center;">
      <div id="es-progress" style="flex:1;height:6px;background:#eee;border-radius:999px;overflow:hidden;">
        <div
          id="es-progress-bar"
          style="width:0%;height:100%;background:var(--color-primary-orange);transition:width .35s ease;"
        ></div>
      </div>
      <span id="es-step-label" style="min-width:90px;text-align:right;font-variant-numeric:tabular-nums;"
        >Step 1 of 4</span
      >
    </div>

    <!-- Wizard -->
    <div class="es-steps" style="position:relative;">
      <!-- 1. Operation -->
      <article class="card es-step" data-step="1" aria-hidden="false">
        <h3 class="h3" style="margin-top:0;">What operation are you doing?</h3>
        <div class="rc-row" role="listbox" aria-label="Operation">
          {% assign ops = 'Profiling|Side Milling|Small Part|Slotting|Die Sinking|Facing|Corner|Helical-Interpol|Trochoidal|Side Taper'
            | split: '|'
          %}
          {% for op in ops %}
            {% assign tag = op | replace: ' ', '_' %}
            <button type="button" class="rc-item es-op" data-tag="Operation_{{ op }}" aria-selected="false">
              <div class="rc-item__label h5">{{ op }}</div>
            </button>
          {% endfor %}
        </div>

        <div style="display:flex;gap:12px;justify-content:space-between;align-items:center;margin-top:var(--space-6);">
          <span class="rc-item__text">Pick one</span>
          <div style="display:flex;gap:8px;">
             <button type="button" class="btn es-skip">Skip</button>
    <button type="button" class="btn btn-primary es-next" disabled>Next</button>
  </div>
        </div>
      </article>

      <!-- 2. Material -->
      <article
        class="card es-step"
        data-step="2"
        aria-hidden="true"
        style="position:absolute;inset:0;opacity:0;pointer-events:none;"
      >
        <h3 class="h3" style="margin-top:0;">What material?</h3>

        <!-- Tabs for ISO letters -->
        <div class="tabs" role="tablist" aria-label="ISO">
          {% assign iso_tabs = 'P|M|K|N|S|H' | split: '|' %}
          {% for i in iso_tabs %}
            <button type="button" class="es-iso-tab" role="tab" data-iso="{{ i }}" aria-selected="{{ forloop.first }}">
              {{ i }}
            </button>
          {% endfor %}
        </div>

        <!-- Material list populated by JS from VDI table below -->
        <div
          class="rc-row"
          id="es-material-grid"
          style="margin-top:var(--space-6);"
          role="listbox"
          aria-label="Material"
        ></div>

        <div class="rc-item__text" style="margin-top:var(--space-4);">
          Tip. We rank Excellent first if your product metafields mark a VDI as excellent.
        </div>

        <div style="display:flex;gap:12px;justify-content:space-between;align-items:center;margin-top:var(--space-6);">
          <button type="button" class="btn btn-outline es-prev">Back</button>
          <div style="display:flex;gap:8px;">
             <button type="button" class="btn es-skip">Skip</button>
    <button type="button" class="btn btn-primary es-next" disabled>Next</button>
  </div>
        </div>
      </article>

      <!-- 3. Cutting shape -->
      <article
        class="card es-step"
        data-step="3"
        aria-hidden="true"
        style="position:absolute;inset:0;opacity:0;pointer-events:none;"
      >
        <h3 class="h3" style="margin-top:0;">What cutting shape?</h3>
        <div class="rc-row" role="listbox" aria-label="Cutting shape">
          {% assign shapes = 'Square|Ball Nose|Corner Radius|Ripper / Rougher|Chamfer Prep' | split: '|' %}
          {% for s in shapes %}
            <button type="button" class="rc-item es-shape" data-tag="Cutting Shape_{{ s }}" aria-selected="false">
              <div class="rc-item__label h5">{{ s }}</div>
            </button>
          {% endfor %}
        </div>

        <div style="display:flex;gap:12px;justify-content:space-between;align-items:center;margin-top:var(--space-6);">
          <button type="button" class="btn btn-outline es-prev">Back</button>
          <div style="display:flex;gap:8px;">
             <button type="button" class="btn es-skip">Skip</button>
    <button type="button" class="btn btn-primary es-next" disabled>Next</button>
  </div>
        </div>
      </article>

      <!-- 4. Length or Type -->
      <article
        class="card es-step"
        data-step="4"
        aria-hidden="true"
        style="position:absolute;inset:0;opacity:0;pointer-events:none;"
      >
        <h3 class="h3" style="margin-top:0;">Length or Type</h3>
        <div class="rc-item__text" style="margin-bottom:var(--space-4);">
          Pick one from Length or Type. If you choose one. the other is set to Any.
        </div>

        <div class="rc-row" role="listbox" aria-label="Length" style="margin-bottom:var(--space-6);">
          {% for L in lengths %}
            <button type="button" class="rc-item es-length" data-tag="Length_{{ L }}" aria-selected="false">
              <div class="rc-item__label h5">{{ L }}</div>
            </button>
          {% endfor %}
        </div>

        <div class="rc-row" role="listbox" aria-label="Type">
          {% for T in types %}
            <button type="button" class="rc-item es-type" data-tag="Type_{{ T }}" aria-selected="false">
              <div class="rc-item__label h5">{{ T }}</div>
            </button>
          {% endfor %}
        </div>

        <div style="display:flex;gap:12px;justify-content:space-between;align-items:center;margin-top:var(--space-6);">
          <button type="button" class="btn btn-outline es-prev">Back</button>
          <div style="display:flex;gap:8px;">
            <button type="button" class="btn es-skip">Skip</button>
    <button type="button" class="btn btn-primary es-next" disabled>Next</button>
  </div>
        </div>
      </article>

      <!-- 5. Diameter -->
      <article
        class="card es-step"
        data-step="5"
        aria-hidden="true"
        style="position:absolute;inset:0;opacity:0;pointer-events:none;"
      >
        <h3 class="h3" style="margin-top:0;">Diameter</h3>

        <div style="display:grid;gap:14px;max-width:520px;">
          <label class="rc-item__label" for="es-dia">Mill Diameter (mm)</label>
          <input
            id="es-dia"
            type="number"
            class="form-input"
            step="0.01"
            min="0"
            placeholder="Optional. e.g. 6 or 6.35"
          >
          <div class="rc-item__text">Leave blank if you’re flexible.</div>
        </div>

        <div style="display:flex;gap:12px;justify-content:space-between;align-items:center;margin-top:var(--space-6);">
          <button type="button" class="btn btn-outline es-prev">Back</button>
          <button type="button" class="btn btn-primary es-finish">Show results</button>
        </div>
      </article>
    </div>

    <!-- Active filters summary -->
    <div id="es-chips" style="display:none;gap:8px;flex-wrap:wrap;margin:22px 0;">
      <span class="wm-chip-group">
        <span class="wm-chip work-mat__chip" id="chip-iso" data-m="P" style="display:none;">ISO</span>
      </span>
      <button class="btn btn-outline" id="es-reset" type="button">Reset</button>
    </div>

    <!-- Results -->
    <div id="es-results">
      <h3 class="h3" style="margin-top:0;">Results</h3>

      {%- comment -%} Editable summary controls shown on results {%- endcomment -%}
      {% assign iso_tabs = 'P|M|K|N|S|H' | split: '|' %}
      {% assign ops = 'Profiling|Side Milling|Small Part|Slotting|Die Sinking|Facing|Corner|Helical-Interpol|Trochoidal|Side Taper'
        | split: '|'
      %}
      {% assign shapes = 'Square|Ball Nose|Corner Radius|Ripper / Rougher|Chamfer Prep' | split: '|' %}

      <div id="es-editable-summary" class="card" style="display:none;margin:16px 0 22px;">
        <h4 class="h4" style="margin-top:0;">Your selections</h4>
        <div class="rc-row">
          <label class="rc-item">
            <span class="rc-item__label">Operation</span>
            <select id="es-sel-operation" class="form-input">
              <option value="">Any</option>
              {% for op in ops %}
                {% assign tag = op | replace: ' ', '_' %}
                <option value="Operation_{{ tag }}">{{ op }}</option>
              {% endfor %}
            </select>
          </label>

          <label class="rc-item">
            <span class="rc-item__label">ISO</span>
            <select id="es-sel-iso" class="form-input">
              {% for i in iso_tabs %}
                <option value="{{ i }}">{{ i }}</option>
              {% endfor %}
            </select>
          </label>

          <label class="rc-item">
            <span class="rc-item__label">Material</span>
            <select id="es-sel-material" class="form-input">
              <option value="">Any</option>
              {# options filled by JS based on ISO. label shows “User · VDI n” #}
            </select>
          </label>

          <label class="rc-item">
            <span class="rc-item__label">Cutting shape</span>
            <select id="es-sel-shape" class="form-input">
              <option value="">Any</option>
              {% for s in shapes %}
                <option value="Cutting Shape_{{ s }}">{{ s }}</option>
              {% endfor %}
            </select>
          </label>

          <label class="rc-item">
            <span class="rc-item__label">Length</span>
            <select id="es-sel-length" class="form-input">
              <option value="">Any</option>
              {% for L in lengths %}
                <option value="Length_{{ L }}">{{ L }}</option>
              {% endfor %}
            </select>
          </label>

          <label class="rc-item">
            <span class="rc-item__label">Type</span>
            <select id="es-sel-type" class="form-input">
              <option value="">Any</option>
              {% for T in types %}
                <option value="Type_{{ T }}">{{ T }}</option>
              {% endfor %}
            </select>
          </label>

          <label class="rc-item">
            <span class="rc-item__label">Diameter (mm)</span>
            <div style="display:flex;gap:8px;align-items:center;">
              <input id="es-sel-dia" type="number" class="form-input" step="0.01" min="0" placeholder="Any">
              <button type="button" class="btn btn-outline" id="es-dia-clear">Clear</button>
            </div>
          </label>
        </div>
      </div>

      <div id="es-empty" class="collection-card__description" style="display:none;">
        No matching products. Loosen a filter or clear Diameter.
      </div>
      <div id="es-grid" class="collection-grid"></div>
    </div>
  </div>

{%- comment -%}Force selector to read from the entire catalog{%- endcomment -%}
{% assign coll = collections['all-endmills'] %}

{% paginate coll.products by 1000 %}
    <template id="es-products-json">
      [
      {% for product in coll.products %}
        {% assign vdi_good = product.metafields.custom.vdi_good.value
          | default: product.metafields.custom.vdi_good
          | default: blank
        %}
        {% assign vdi_exc = product.metafields.custom.vdi_excellent.value
          | default: product.metafields.custom.vdi_excellent
          | default: blank
        %}

        {%- comment -%} gather diameters from variants by option name {%- endcomment -%}
        {%- assign dia_values = '' -%}
        {%- assign dia_index = null -%}
        {%- for opt in product.options_with_values -%}
          {%- if opt.name == 'Mill Diameter (mm)' -%}{%- assign dia_index = forloop.index0 -%}{%- endif -%}
        {%- endfor -%}
        {%- if dia_index == null -%}{%- assign dia_index = 0 -%}{%- endif -%}
        {%- assign dlist = '' -%}
        {%- for v in product.variants -%}
          {%- assign d = v.options[dia_index] | strip -%}
          {%- if d and d != '' -%}
            {%- capture dlist -%}{{ dlist }}{% if dlist != '' %},{% endif %}"{{ d | replace: '"','\"' }}"{%- endcapture -%}
          {%- endif -%}
        {%- endfor -%}

        { "id": {{ product.id }}, "handle": {{ product.handle | json }}, "title": {{ product.title | json }}, "url":
        {{ product.url | json }}, "tags": {{ product.tags | json }}, "vdi_good":
        {{ vdi_good | default: '[]' | json | replace: '\"[', '[' | replace: ']\"', ']' }}, "vdi_excellent":
        {{ vdi_exc | default: '[]' | json | replace: '\"[', '[' | replace: ']\"', ']' }}, "option_names":
        {{ product.options_with_values | map: 'name' | json }}, "diameters": [{{ dlist }}], "variants": [
        {%- for v in product.variants -%}
          {%- assign _dia = '' -%}
          {%- assign _rad = '' -%}
          {%- assign _shank_opt = '' -%}
          {%- for opt in product.options_with_values -%}
            {%- assign nm = opt.name | strip -%}
            {%- assign val = v.options[forloop.index0] | default: '' -%}
            {%- if nm == 'Mill Diameter (mm)' -%}{%- assign _dia = val -%}{%- endif -%}
            {%- if nm == 'Corner Radius (mm)' -%}{%- assign _rad = val -%}{%- endif -%}
            {%- if nm == 'Shank Diameter (mm)' -%}{%- assign _shank_opt = val -%}{%- endif -%}
          {%- endfor -%}
          { "id": {{ v.id }}, "sku": {{ v.sku | json }}, "price": {{ v.price | default: 0 }}, "compare_at_price":
          {{ v.compare_at_price | default: 0 }}, "available": {{ v.available | json }}, "inventory_management":
          {{ v.inventory_management | json }}, "inventory_quantity": {{ v.inventory_quantity | default: 0 }},
          "inventory_policy": {{ v.inventory_policy | json }}, "incoming": {{ v.incoming | json }},
          "next_incoming_date": {{ v.next_incoming_date | json }}, "options": {{ v.options | json }}, "dia_mm":
          {{ _dia | json }}, "corner_radius_mm": {{ _rad | json }}, "shank_diameter_mm_opt": {{ _shank_opt | json }},
          "shank_diameter_mm_mf":
          {{ v.metafields.filter.shank_diameter_mm | default: v.metafields.filter.shank_diameter_mm | json }},
          "length_of_cut_mm":
          {{ v.metafields.custom.length_of_cut_mm | default: v.metafields.custom.length_of_cut_mm | json }} }
          {%- unless forloop.last -%},{%- endunless -%}
        {%- endfor -%}
        ] }
        {% unless forloop.last %},{% endunless %}
      {% endfor %}
      ]
    </template>

    {% comment %} Pre-render card templates so we keep your complex price logic. {% endcomment %}
    <div style="display:none;">
      {% for product in coll.products %}
        <template id="tpl-{{ product.id }}">
          {% render 'product-grid-item-endmill-selector', product: product %}
        </template>
      {% endfor %}
    </div>
  {% endpaginate %}

  {% comment %} ====== MATERIAL TABLE (VDI → ISO + Label) ====== {% endcomment %}
  <script type="application/json" id="es-vdi-table">
    [
      {
        "vdi": 1,
        "iso": "P",
        "desc": "Non-alloy steel · ~0.15% C · Annealed",
        "hrc": 9,
        "user": "Mild Steel (Low Carbon)"
      },
      {
        "vdi": 2,
        "iso": "P",
        "desc": "Non-alloy steel · ~0.45% C · Annealed",
        "hrc": 13,
        "user": "Medium Carbon Steel"
      },
      {
        "vdi": 3,
        "iso": "P",
        "desc": "Non-alloy steel · ~0.45% C · Quenched & Tempered",
        "hrc": 25,
        "user": "Medium Carbon Steel (Q&T)"
      },
      { "vdi": 4, "iso": "P", "desc": "Non-alloy steel · ~0.75% C · Annealed", "hrc": 28, "user": "High Carbon Steel" },
      {
        "vdi": 5,
        "iso": "P",
        "desc": "Non-alloy steel · ~0.75% C · Quenched & Tempered",
        "hrc": 32,
        "user": "High Carbon Steel (Q&T)"
      },
      { "vdi": 6, "iso": "P", "desc": "Low alloy steel · Annealed", "hrc": 10, "user": "Low Alloy Steel" },
      { "vdi": 7, "iso": "P", "desc": "Low alloy steel · Quenched & Tempered", "hrc": 29, "user": "Alloy Steel (Q&T)" },
      {
        "vdi": 8,
        "iso": "P",
        "desc": "Low alloy steel · Quenched & Tempered",
        "hrc": 32,
        "user": "Alloy Steel (Toughened)"
      },
      {
        "vdi": 9,
        "iso": "P",
        "desc": "Low alloy steel · Quenched & Tempered",
        "hrc": 38,
        "user": "High Strength Steel / Wear Plate"
      },
      {
        "vdi": 10,
        "iso": "P",
        "desc": "High alloyed steel, tool steel · Annealed",
        "hrc": 15,
        "user": "Tool Steel (Annealed)"
      },
      {
        "vdi": 11,
        "iso": "P",
        "desc": "High alloyed steel, tool steel · Quenched & Tempered",
        "hrc": 35,
        "user": "Tool Steel (Hardened)"
      },
      {
        "vdi": 12,
        "iso": "M",
        "desc": "Stainless steel · Ferritic/Martensitic · Annealed",
        "hrc": 15,
        "user": "Stainless Steel (Hard Grades)"
      },
      {
        "vdi": 13,
        "iso": "M",
        "desc": "Stainless steel · Martensitic · Quenched & Tempered",
        "hrc": 23,
        "user": "Stainless Steel (Hardened)"
      },
      {
        "vdi": 14,
        "iso": "M",
        "desc": "Stainless steel · Austenitic",
        "hrc": 10,
        "user": "Stainless Steel (Austenitic 304/316)"
      },
      { "vdi": 15, "iso": "K", "desc": "Grey cast iron · Pearlitic/Ferritic", "hrc": 10, "user": "Cast Iron (Soft)" },
      {
        "vdi": 16,
        "iso": "K",
        "desc": "Grey cast iron · Pearlitic (Martensitic)",
        "hrc": 26,
        "user": "Cast Iron (Hard)"
      },
      { "vdi": 17, "iso": "K", "desc": "Nodular cast iron · Ferritic", "hrc": 3, "user": "Ductile Iron (Soft)" },
      { "vdi": 18, "iso": "K", "desc": "Nodular cast iron · Pearlitic", "hrc": 25, "user": "Ductile Iron (Hard)" },
      { "vdi": 19, "iso": "K", "desc": "Malleable cast iron · Ferritic", "hrc": 0, "user": "Malleable Iron (Soft)" },
      { "vdi": 20, "iso": "K", "desc": "Malleable cast iron · Pearlitic", "hrc": 21, "user": "Malleable Iron (Hard)" },
      {
        "vdi": 21,
        "iso": "N",
        "desc": "Aluminum-wrought alloy · Not curable",
        "hrc": 0,
        "user": "Aluminium (Soft Wrought)"
      },
      {
        "vdi": 22,
        "iso": "N",
        "desc": "Aluminum-wrought alloy · Curable · Hardened",
        "hrc": 0,
        "user": "Aluminium (Heat-Treated 6061/7075)"
      },
      {
        "vdi": 23,
        "iso": "N",
        "desc": "Aluminum-cast, alloyed ≤12% Si · Not Curable",
        "hrc": 0,
        "user": "Cast Aluminium (Low Si)"
      },
      {
        "vdi": 24,
        "iso": "N",
        "desc": "Aluminum-cast, alloyed ≤12% Si · Curable · Hardened",
        "hrc": 0,
        "user": "Cast Aluminium (Treated)"
      },
      {
        "vdi": 25,
        "iso": "N",
        "desc": "Aluminum-cast, alloyed >12% Si · Not Curable",
        "hrc": 0,
        "user": "Cast Aluminium (High Si)"
      },
      {
        "vdi": 26,
        "iso": "N",
        "desc": "Copper and Copper Alloys · Cutting alloys · Pb>1%",
        "hrc": 0,
        "user": "Free-Cutting Brass / Bronze"
      },
      {
        "vdi": 27,
        "iso": "N",
        "desc": "Copper and Copper Alloys (Bronze/Brass) · CuZn, CuSnZn",
        "hrc": 0,
        "user": "Brass & Bronze (General)"
      },
      {
        "vdi": 28,
        "iso": "N",
        "desc": "Copper and Copper Alloys · CuSn, lead-free copper",
        "hrc": 0,
        "user": "Copper (Pure & Lead-Free)"
      },
      {
        "vdi": 29,
        "iso": "N",
        "desc": "Non Metallic Materials · Durolastic, Fiber Reinforced Plastic",
        "hrc": null,
        "user": "Composites (FRP / Reinforced Plastics)"
      },
      {
        "vdi": 30,
        "iso": "N",
        "desc": "Non Metallic Materials · Rubber, Wood, etc.",
        "hrc": null,
        "user": "Non-Metallic (Plastics / Rubber / Wood)"
      },
      {
        "vdi": 31,
        "iso": "S",
        "desc": "Heat Resistant Super Alloys · Fe Based · Annealed",
        "hrc": 15,
        "user": "Iron-Based Super Alloys"
      },
      {
        "vdi": 32,
        "iso": "S",
        "desc": "Heat Resistant Super Alloys · Fe Based · Cured",
        "hrc": 30,
        "user": "Iron-Based Super Alloys (Treated)"
      },
      {
        "vdi": 33,
        "iso": "S",
        "desc": "Heat Resistant Super Alloys · Ni or Co Based · Annealed",
        "hrc": 25,
        "user": "Nickel & Cobalt Alloys"
      },
      {
        "vdi": 34,
        "iso": "S",
        "desc": "Heat Resistant Super Alloys · Ni or Co Based · Cured",
        "hrc": 38,
        "user": "Nickel & Cobalt Alloys (Hardened)"
      },
      {
        "vdi": 35,
        "iso": "S",
        "desc": "Heat Resistant Super Alloys · Ni or Co Based · Cast",
        "hrc": 34,
        "user": "Nickel & Cobalt Alloys (Cast)"
      },
      {
        "vdi": 36,
        "iso": "S",
        "desc": "Titanium Alloys · Pure Titanium",
        "hrc": null,
        "user": "Titanium (Commercially Pure)"
      },
      {
        "vdi": 37,
        "iso": "S",
        "desc": "Titanium Alloys · Alpha + Beta Alloys · Hardened",
        "hrc": null,
        "user": "Titanium (Alloyed / Hardened)"
      },
      { "vdi": 38, "iso": "H", "desc": "Hardened steel · Hardened", "hrc": 55, "user": "Hardened Steel (≈55 HRC)" },
      { "vdi": 39, "iso": "H", "desc": "Hardened steel · Hardened", "hrc": 60, "user": "Hardened Steel (≈60 HRC)" },
      { "vdi": 40, "iso": "H", "desc": "Chilled Cast Iron · Cast", "hrc": 42, "user": "Chilled Cast Iron" },
      { "vdi": 41, "iso": "H", "desc": "Hardened Cast Iron · Hardened", "hrc": 55, "user": "Hardened Cast Iron" }
    ]
  </script>

  {% comment %} ====== JS ====== {% endcomment %}
  <script>
    (function () {
      const el = (sel, root = document) => root.querySelector(sel);
      const els = (sel, root = document) => Array.from(root.querySelectorAll(sel));
      const steps = els('.es-step');
      const bar = el('#es-progress-bar');
      const stepLabel = el('#es-step-label');
      let step = 1;

      const selected = {
        operationTag: null,
        iso: 'P',
        vdi: null,
        materialLabel: null,
        shapeTag: null,
        lengthTag: null,
        typeTag: null,
        diameter: null,
      };

      // Progress
      const setStep = (n) => {
        step = n;
        steps.forEach((s) => {
          const active = Number(s.dataset.step) === n;
          s.style.opacity = active ? 1 : 0;
          s.style.pointerEvents = active ? 'auto' : 'none';
          s.style.position = active ? 'relative' : 'absolute';
          s.setAttribute('aria-hidden', String(!active));
        });
        bar.style.width = ((n - 1) / 4) * 100 + '%';
        stepLabel.textContent = `Step ${n} of 5`;
      };

      // Operation choices
      els('.es-op').forEach((btn) => {
        btn.addEventListener('click', () => {
          els('.es-op').forEach((b) => b.setAttribute('aria-selected', 'false'));
          btn.setAttribute('aria-selected', 'true');
          selected.operationTag = btn.dataset.tag;
          btn.closest('.es-step').querySelector('.es-next').disabled = false;
        });
      });



      // ISO tabs + materials grid
      const MAT = JSON.parse(el('#es-vdi-table').textContent);
      const matGrid = el('#es-material-grid');
      const renderMaterials = (iso) => {
        matGrid.innerHTML = '';
        MAT.filter((m) => m.iso === iso).forEach((m) => {
          const item = document.createElement('button');
          item.type = 'button';
          item.className = 'rc-item es-mat';
          item.dataset.vdi = m.vdi;
          item.dataset.iso = m.iso;
          item.setAttribute('aria-selected', 'false');
          item.innerHTML = `
          <div class="rc-item__label h5">${m.user}</div>
          <div class="rc-item__text">${m.desc}${m.hrc != null ? ` · HRC ${m.hrc}` : ''} · VDI ${m.vdi}</div>
        `;
          item.addEventListener('click', () => {
            els('.es-mat').forEach((b) => b.setAttribute('aria-selected', 'false'));
            item.setAttribute('aria-selected', 'true');
            selected.vdi = Number(item.dataset.vdi);
            selected.iso = item.dataset.iso;
            selected.materialLabel = m.user;
            item.closest('.es-step').querySelector('.es-next').disabled = false;
          });
          matGrid.appendChild(item);
        });
      };

      // === Editable summary ===
      const summaryEl = el('#es-editable-summary');
      const selOp = () => el('#es-sel-operation');
      const selISO = () => el('#es-sel-iso');
      const selMat = () => el('#es-sel-material');
      const selSh = () => el('#es-sel-shape');
      const selLen = () => el('#es-sel-length');
      const selDia = () => el('#es-sel-dia');
      const btnDiaC = () => el('#es-dia-clear');
      const selType = () => el('#es-sel-type');

      function buildMaterialOptions(iso, currentVDI) {
        const opts = [`<option value="">Any</option>`];
        MAT.filter((m) => m.iso === iso).forEach((m) => {
          const label = `${m.user} · VDI ${m.vdi}`;
          const sel = currentVDI === m.vdi ? ' selected' : '';
          opts.push(`<option value="${m.vdi}"${sel}>${label}</option>`);
        });
        selMat().innerHTML = opts.join('');
      }

      function syncSummaryFromState() {
        // Operation
        selOp().value = selected.operationTag || '';
        // ISO + material
        selISO().value = selected.iso || 'P';
        buildMaterialOptions(selISO().value, selected.vdi ?? null);
        // Shape
        selSh().value = selected.shapeTag || '';
        // Diameter
        selDia().value = selected.diameter != null ? String(selected.diameter) : '';
        selLen().value = selected.lengthTag || '';
        selType().value = selected.typeTag || '';
      }

      function attachSummaryHandlersOnce() {
        if (summaryEl.dataset.bound === '1') return;

        selOp().addEventListener('change', () => {
          selected.operationTag = selOp().value || null;
          renderResults();
          renderChips();
        });

        selType().addEventListener('change', () => {
          selected.typeTag = selType().value || null;
          if (selected.typeTag) {
            // make Length = Any
            selLen().value = '';
            selected.lengthTag = null;
          }
          renderResults();
          renderChips();
        });

        selISO().addEventListener('change', () => {
          selected.iso = selISO().value;
          // ISO change clears VDI selection until user picks one
          selected.vdi = null;
          selected.materialLabel = null;
          buildMaterialOptions(selected.iso, null);
          renderResults();
          renderChips();
        });

        selMat().addEventListener('change', () => {
          const v = selMat().value;
          if (v === '') {
            selected.vdi = null;
            selected.materialLabel = null;
          } else {
            selected.vdi = Number(v);
            const m = MAT.find((x) => x.vdi === selected.vdi);
            selected.materialLabel = m ? m.user : null;
            selected.iso = m ? m.iso : selected.iso;
            selISO().value = selected.iso; // keep ISO select in sync
          }
          renderResults();
          renderChips();
        });

        selSh().addEventListener('change', () => {
          selected.shapeTag = selSh().value || null;
          renderResults();
          renderChips();
        });

        selLen().addEventListener('change', () => {
          selected.lengthTag = selLen().value || null;
          if (selected.lengthTag) {
            // make Type = Any
            selType().value = '';
            selected.typeTag = null;
          }
          renderResults();
          renderChips();
        });

        selDia().addEventListener('input', () => {
          const v = selDia().value.trim();
          selected.diameter = v === '' ? null : Number(v);
          renderResults();
          renderChips();
        });

        btnDiaC().addEventListener('click', () => {
          selDia().value = '';
          selected.diameter = null;
          renderResults();
          renderChips();
        });

        summaryEl.dataset.bound = '1';
      }

      function showSummary() {
        summaryEl.style.display = 'block';
        attachSummaryHandlersOnce();
        syncSummaryFromState();
      }

      // clear UI selections within a step
function clearSelectionsIn(stepEl){
  if (!stepEl) return;
  // unselect all toggles in this step
  Array.from(stepEl.querySelectorAll('[aria-selected]')).forEach(b => b.setAttribute('aria-selected','false'));
  // clear inputs in this step
  Array.from(stepEl.querySelectorAll('input[type="number"],input[type="text"]')).forEach(i => i.value = '');
}

function doFinish(){
  setStep(4);
  renderResults();
  renderChips();
  showSummary();
  window.scrollTo({ top: el('#es-results').offsetTop - 20, behavior: 'smooth' });
}

// Skip buttons: set this step to "Any" and advance
els('.es-skip').forEach(btn => {
  btn.addEventListener('click', () => {
    const stepEl = btn.closest('.es-step');
    const n = Number(stepEl?.dataset.step || 0);

    switch (n) {
      case 1: // Operation -> Any
        selected.operationTag = null;
        break;
      case 2: // Material -> Any (keep ISO tab as-is. clear VDI)
        selected.vdi = null;
        selected.materialLabel = null;
        break;
      case 3: // Shape -> Any
        selected.shapeTag = null;
        break;
      case 4: // Length/Type -> Any
        selected.lengthTag = null;
        selected.typeTag = null;
        break;
      case 5: // Diameter -> Any. then finish
        selected.diameter = null;
        el('#es-dia').value = '';
        clearSelectionsIn(stepEl);
        doFinish();
        return; // don't call setStep again
    }

    clearSelectionsIn(stepEl);
    setStep(Math.min(5, n + 1));
  });
});


      els('.es-iso-tab').forEach((tab) => {
        tab.addEventListener('click', () => {
          els('.es-iso-tab').forEach((t) => t.setAttribute('aria-selected', 'false'));
          tab.setAttribute('aria-selected', 'true');
          selected.iso = tab.dataset.iso;
          selected.vdi = null;
          renderMaterials(selected.iso);
          const nx = tab.closest('.es-step').querySelector('.es-next');
          if (nx) nx.disabled = true;
        });
      });
      renderMaterials(selected.iso);

      // Shape choices
      els('.es-shape').forEach((btn) => {
        btn.addEventListener('click', () => {
          els('.es-shape').forEach((b) => b.setAttribute('aria-selected', 'false'));
          btn.setAttribute('aria-selected', 'true');
          selected.shapeTag = btn.dataset.tag;
          btn.closest('.es-step').querySelector('.es-next').disabled = false;
        });
      });

      // Length choices
      els('.es-length').forEach((btn) => {
        btn.addEventListener('click', () => {
          // clear Type selections
          els('.es-type').forEach((b) => b.setAttribute('aria-selected', 'false'));
          selected.typeTag = null;

          // set Length
          els('.es-length').forEach((b) => b.setAttribute('aria-selected', 'false'));
          btn.setAttribute('aria-selected', 'true');
          selected.lengthTag = btn.dataset.tag;

          btn.closest('.es-step').querySelector('.es-next').disabled = false;
        });
      });

      els('.es-type').forEach((btn) => {
        btn.addEventListener('click', () => {
          // clear Length selections
          els('.es-length').forEach((b) => b.setAttribute('aria-selected', 'false'));
          selected.lengthTag = null;

          // set Type
          els('.es-type').forEach((b) => b.setAttribute('aria-selected', 'false'));
          btn.setAttribute('aria-selected', 'true');
          selected.typeTag = btn.dataset.tag;

          btn.closest('.es-step').querySelector('.es-next').disabled = false;
        });
      });

      // Diameter
      el('#es-dia').addEventListener('input', (e) => {
        const v = e.target.value.trim();
        selected.diameter = v === '' ? null : Number(v);
      });

      // Nav buttons
      els('.es-next').forEach((b) => b.addEventListener('click', () => setStep(Math.min(5, step + 1))));
      els('.es-prev').forEach((b) => b.addEventListener('click', () => setStep(Math.max(1, step - 1))));
      el('.es-finish').addEventListener('click', () => {
        setStep(4);
        renderResults();
        renderChips();
        showSummary();
        window.scrollTo({ top: el('#es-results').offsetTop - 20, behavior: 'smooth' });
      });
      // Reset
      el('#es-reset').addEventListener('click', () => {
        // clear selections
        selected.operationTag = null;
        selected.iso = 'P';
        selected.vdi = null;
        selected.materialLabel = null;
        selected.shapeTag = null;
        selected.lengthTag = null;
        selected.typeTag = null;
        selected.diameter = null;

        // UI reset
        els('.es-op,.es-mat,.es-shape,.es-length,.es-type').forEach((b) => b.setAttribute('aria-selected', 'false'));
        els('.es-next').forEach((n) => (n.disabled = true));
        els('.es-iso-tab').forEach((t, i) => t.setAttribute('aria-selected', String(i === 0)));
        el('#es-dia').value = '';
        renderMaterials('P');
        el('#es-chips').style.display = 'none';
        el('#es-grid').innerHTML = '';
        el('#es-empty').style.display = 'none';
        setStep(1);

        summaryEl.style.display = 'none';
        if (summaryEl.dataset.bound !== '1') attachSummaryHandlersOnce();
        // default selects
        selOp().value = '';
        selISO().value = 'P';
        buildMaterialOptions('P', null);
        selMat().value = '';
        selSh().value = '';
        selDia().value = '';
        selLen().value = '';
        selType().value = '';
      });

      // Data load
      const PRODUCT_DATA = JSON.parse(el('#es-products-json').innerHTML.trim());
      window.PRODUCT_DATA = PRODUCT_DATA;

      // Normalize metafields. They may arrive as strings. Try to coerce.
      PRODUCT_DATA.forEach((p) => {
        p.vdi_good = tryParseArray(p.vdi_good);
        p.vdi_excellent = tryParseArray(p.vdi_excellent);
        p.diameters = (p.diameters || []).map((x) => Number(String(x).replace(',', '.')));
      });

      function tryParseArray(v){
  if (!v) return [];
  if (Array.isArray(v)) return v.map(Number).filter(n => !isNaN(n));
  const nums = String(v).match(/\d+(?:\.\d+)?/g);
  return nums ? nums.map(Number).filter(n => !isNaN(n)) : [];
}


      function normalizeTag(t) {
        return String(t)
          .toLowerCase()
          .replace(/[^a-z0-9]/g, '');
      }

      function isEndmill(p) {
        return p.tags.some((t) => /^Cutting Shape_/i.test(t));
      }

      function hasExcludedTag(p) {
        const t = p.tags.map(normalizeTag);
        return t.includes('operationblinddrilling') || t.includes('operationthroughdrilling');
      }

      // Work on endmills only. not drills
      const DATASET = PRODUCT_DATA.filter((p) => isEndmill(p) && !hasExcludedTag(p));

      function hasExcludedTag(p) {
        const t = p.tags.map(normalizeTag);
        return t.includes('operationblinddrilling') || t.includes('operationthroughdrilling');
      }

      function matchesProduct(p) {
        const tagsNorm = p.tags.map(normalizeTag);

        // Exclude all Blind / Through drilling operations
        if (tagsNorm.includes('operationblinddrilling') || tagsNorm.includes('operationthroughdrilling')) {
          return false;
        }

        // Operation tag
        if (selected.operationTag) {
          const opNorm = normalizeTag(selected.operationTag);
          if (!tagsNorm.includes(opNorm)) return false;
        }

        // Shape tag
        if (selected.shapeTag) {
          const shapeNorm = normalizeTag(selected.shapeTag);
          if (!tagsNorm.includes(shapeNorm)) return false;
        }

        // Length vs Type. only one applies
        if (selected.typeTag) {
          const tNorm = normalizeTag(selected.typeTag);
          if (!tagsNorm.includes(tNorm)) return false;
        } else if (selected.lengthTag) {
          const lenNorm = normalizeTag(selected.lengthTag);
          if (!tagsNorm.includes(lenNorm)) return false;
        }

        // Material VDI
        if (selected.vdi != null) {
          const vd = Number(selected.vdi);
          const good = (p.vdi_good || []).map(Number);
          const exc = (p.vdi_excellent || []).map(Number);
          if (![...good, ...exc].includes(vd)) return false;
        }

        // Diameter
        if (selected.diameter != null) {
          const want = Number(selected.diameter);
          const has = (p.diameters || []).some((d) => Math.abs(d - want) < 0.01);
          if (!has) return false;
        }

        return true;
      }

      // Render results
      function renderResults() {
        const grid = el('#es-grid');
        grid.innerHTML = '';
        const matches = PRODUCT_DATA.filter(matchesProduct);

        if (matches.length === 0) {
          el('#es-empty').style.display = 'block';
          return;
        }
        el('#es-empty').style.display = 'none';

        // Prioritize products that mark the selected VDI as excellent
        matches.sort((a, b) => {
          if (selected.vdi == null) return 0;
          const vd = Number(selected.vdi);
          const ax = (a.vdi_excellent || []).includes(vd) ? 1 : 0;
          const bx = (b.vdi_excellent || []).includes(vd) ? 1 : 0;
          if (ax !== bx) return bx - ax;
          // tie-breaker. keep original
          return 0;
        });

        const frag = document.createDocumentFragment();
        matches.forEach((p) => {
          const tpl = el(`#tpl-${p.id}`);
          if (!(tpl && 'content' in tpl)) return;
          const node = tpl.content.cloneNode(true);

          // pick exact variant by diameter if provided
          let matchVid = null;
          if (selected.diameter != null) {
            const want = Number(selected.diameter);
            // tolerate 0.01 mm
            const v = (p.variants || []).find((vv) => {
              const d = Number(String(vv.dia_mm || '').replace(',', '.'));
              return !isNaN(d) && Math.abs(d - want) < 0.01;
            });
            if (v) matchVid = String(v.id);
          }
          // fallback: first available
          if (!matchVid && p.variants && p.variants.length) {
            const avail = p.variants.find((vv) => vv.available) || p.variants[0];
            matchVid = String(avail.id);
          }

          // annotate card root so the snippet script can hydrate
          const root = node.querySelector('.product-grid-item');
          if (root) {
            root.setAttribute('data-variant-id', matchVid || '');
            // stash product JSON for the card hydrator
            root.setAttribute('data-product-json', JSON.stringify(p));
            // annotate suitability info
let suitability = '';
if (selected.vdi != null) {
  const vd = Number(selected.vdi);
  const isExc = (p.vdi_excellent || []).includes(vd);
  suitability = isExc ? 'Excellent' : 'Good';
}
root.setAttribute('data-suitability', suitability);
root.setAttribute('data-op-label', selected.operationTag || '');
root.setAttribute('data-material-label', selected.materialLabel || '');

          }

          frag.appendChild(node);
        });
        grid.appendChild(frag);

        // tell cards to hydrate themselves now that attributes are set
        grid.querySelectorAll('.product-grid-item').forEach((el) => {
          el.dispatchEvent(new CustomEvent('es:hydrate-card', { bubbles: true }));
        });

        el('#es-chips').style.display = 'flex';
      }

      const matches = DATASET.filter(matchesProduct);

      // Chips summary
      function renderChips() {
        const chipIso = el('#chip-iso');
        if (selected.iso) {
          chipIso.style.display = 'inline-grid';
          chipIso.dataset.m = selected.iso;
          chipIso.textContent = selected.iso;
        } else {
          chipIso.style.display = 'none';
        }
        // You can add more chips here if you want visible operation/shape/diameter.
      }

      // Initial
      setStep(1);
    })();
  </script>

  <style>
        /* Wizard step transitions */
        .es-step{
          transition: opacity .35s ease, transform .35s ease;
          transform: translateY(0);
        }
        .es-step[aria-hidden="true"]{ transform: translateY(6px); }
        .rc-item[aria-selected="true"]{
          border: 2px solid var(--color-primary-orange) !important;
        }
        .rc-item__label.h5 {
        display: flex;
        align-items: center;
        justify-content: center;
        }
        button.rc-item {
        border-radius: 10px;
    }
    div#es-material-grid {
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }
    button.rc-item.es-mat [data-iso="P"] {
        background: #0069a720;
    }
    .grid-item.large--one-quarter.medium-down--one-half{
    width: 100%;
    }
    .product-grid-image--centered {
        background: #f1f1f1;
        border-radius: 15px;
        margin-bottom: var(--space-5);
    }
    .btn.es-skip { background: transparent; border: 2px solid #e5e5e5; }
    .btn.es-skip:hover { background: #fafafa; }
  </style>
</section>

{% schema %}
{
  "name": "Endmill Product Selector",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Source collection",
      "info": "All products to consider for filtering"
    }
  ],
  "presets": [{ "name": "Endmill Product Selector" }]
}
{% endschema %}
