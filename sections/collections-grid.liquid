{% liquid
  assign heading = section.settings.heading | default: page.title
  assign intro = section.settings.intro
  assign show_page_content = section.settings.show_page_content and page and page.content != blank
  assign button_label = section.settings.button_label | default: 'Shop collection'

  # --- Build a list of collection HANDLES from metafields ---
  assign handle_list = blank

  # 1) Preferred: List of handles (Page metafield: custom.collection_handles, List->Text)
  if page.metafields.custom.collection_handles and page.metafields.custom.collection_handles != blank
    assign handle_list = page.metafields.custom.collection_handles
  # 2) Or: List of URLs (Page metafield: custom.collection_urls, List->Text)
  elsif page.metafields.custom.collection_urls and page.metafields.custom.collection_urls != blank
    assign urls = page.metafields.custom.collection_urls
    assign handles_csv = ''
    for u in urls
      assign h = u | split: '/collections/' | last | split: '?' | first | split: '/' | first
      if h != blank
        if handles_csv == ''
          assign handles_csv = h
        else
          assign handles_csv = handles_csv | append: ',' | append: h
        endif
      endif
    endfor
    if handles_csv != ''
      assign handle_list = handles_csv | split: ','
    endif
  # 3) Nice-to-have fallback: try your original list-of-collections metafield
  elsif page.metafields.custom.collection_grid_collections
    assign mf = page.metafields.custom.collection_grid_collections
    assign items = blank
    if mf.value and mf.value != blank
      assign items = mf.value
    elsif mf.references and mf.references != blank
      assign items = mf.references | map: 'value'
    endif
    if items
      assign handles_csv = ''
      for c in items
        assign h = ''
        if c and c.handle
          assign h = c.handle
        elsif c and c.url
          assign h = c.url | split: '/collections/' | last | split: '?' | first | split: '/' | first
        endif
        if h != blank
          if handles_csv == ''
            assign handles_csv = h
          else
            assign handles_csv = handles_csv | append: ',' | append: h
          endif
        endif
      endfor
      if handles_csv != ''
        assign handle_list = handles_csv | split: ','
      endif
    endif
  endif
%}

<section class="section section--collections-grid" aria-labelledby="collection-grid-heading">
  <div class="layout-constrained">
    {% if heading != blank or intro != blank or show_page_content %}
      <header class="section__header">
        {% if heading != blank %}
          <h1 id="collection-grid-heading" class="section__title text-h2">{{ heading | escape }}</h1>
        {% endif %}
        {% if intro != blank %}
          <div class="section__intro text-p1">{{ intro }}</div>
        {% endif %}
        {% if show_page_content %}
          <div class="section__content rte">{{ page.content }}</div>
        {% endif %}
      </header>
    {% endif %}

    {% if handle_list and handle_list != blank and handle_list.size > 0 %}
      <div class="collection-grid" role="list">
        {% for handle in handle_list %}
          {% assign collection = collections[handle] %}
          {% if collection %}
            {% liquid
              assign short_description = collection.metafields.custom.short_description
              assign collection_image = collection.image
              assign image_alt = ''
              if collection_image and collection_image.alt != blank
                assign image_alt = collection_image.alt
              else
                assign image_alt = collection.title
              endif
            %}
            <article class="collection-card" role="listitem">
              <div class="collection-card__media">
                {% if collection_image %}
                  {{ collection_image | image_url: width: 960 | image_tag: class: 'collection-card__image', loading: 'lazy', widths: '320, 480, 640, 800, 960', sizes: '(min-width: 1080px) 320px, (min-width: 768px) 45vw, 90vw', alt: image_alt, decoding: 'async' }}
                {% else %}
                  <div class="collection-card__placeholder text-p1" role="img" aria-label="{{ collection.title | escape }} image placeholder">Image coming soon</div>
                {% endif %}
              </div>
              <div class="collection-card__body">
                <h2 class="collection-card__title text-h4"><a href="{{ collection.url }}" class="collection-card__link">{{ collection.title }}</a></h2>
                {% if short_description != blank %}
                  <p class="collection-card__description text-p1">{{ short_description | strip_html }}</p>
                {% endif %}
                <div class="collection-card__actions">
                  <a class="btn btn-primary" href="{{ collection.url }}">{{ button_label | escape }}</a>
                </div>
              </div>
            </article>
          {% endif %}
        {% endfor %}
      </div>
    {% else %}
      <div class="collection-grid__empty text-p1">No collections have been assigned to this page yet.</div>
    {% endif %}
  </div>
</section>

{% schema %}
{
  "name": "Collections grid",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Shop collections"
    },
    {
      "type": "richtext",
      "id": "intro",
      "label": "Intro text"
    },
    {
      "type": "checkbox",
      "id": "show_page_content",
      "label": "Show page content",
      "default": false
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "Button label",
      "default": "Shop collection"
    }
  ],
  "presets": [
    {
      "name": "Collections grid"
    }
  ]
}
{% endschema %}
