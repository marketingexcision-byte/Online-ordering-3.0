{% liquid
  assign heading = section.settings.heading | default: page.title
  assign intro = section.settings.intro
  assign show_page_content = section.settings.show_page_content and page and page.content != blank
  assign button_label = section.settings.button_label | default: 'Shop collection'

  ################################################################################
  # Build a list of collection HANDLES
  ################################################################################
  assign handle_list = blank
  assign handles_field = page.metafields.custom.collection_handles
  assign urls_field    = page.metafields.custom.collection_urls

  # Prefer handles (List->Text)
  if handles_field and handles_field != blank
    assign handle_list = handles_field.value | default: handles_field
  endif

  # If still blank, scan ALL namespaces for collection_handles
  if handle_list == blank or handle_list.size == 0
    for ns_pair in page.metafields
      assign ns = ns_pair[0]
      assign bucket = page.metafields[ns]
      assign candidate = bucket['collection_handles']
      if candidate and candidate != blank
        assign handle_list = candidate.value | default: candidate
        break
      endif
    endfor
  endif

  # If still blank, try URLs (List->URL) in 'custom' first
  if (handle_list == blank or handle_list.size == 0) and (urls_field and urls_field != blank)
    assign urls_array = urls_field.value | default: urls_field
    assign handles_csv = ''
    for u in urls_array
      assign url_str = ''
      if u.url
        assign url_str = u.url
      else
        assign url_str = u
      endif
      assign h = url_str | split: '/collections/' | last | split: '?' | first | split: '/' | first | strip | downcase
      if h != blank
        if handles_csv == '' 
          assign handles_csv = h
        else
          assign handles_csv = handles_csv | append: ',' | append: h
        endif
      endif
    endfor
    if handles_csv != '' 
      assign handle_list = handles_csv | split: ','
    endif
  endif

  # If still blank, scan ALL namespaces for collection_urls
  if handle_list == blank or handle_list.size == 0
    assign handles_csv = ''
    for ns_pair in page.metafields
      assign ns = ns_pair[0]
      assign bucket = page.metafields[ns]
      assign uf = bucket['collection_urls']
      if uf and uf != blank
        assign urls_array = uf.value | default: uf
        for u in urls_array
          assign url_str = ''
          if u.url
            assign url_str = u.url
          else
            assign url_str = u
          endif
          assign h = url_str | split: '/collections/' | last | split: '?' | first | split: '/' | first | strip | downcase
          if h != blank
            if handles_csv == '' 
              assign handles_csv = h
            else
              assign handles_csv = handles_csv | append: ',' | append: h
            endif
          endif
        endfor
        break
      endif
    endfor
    if handles_csv != '' 
      assign handle_list = handles_csv | split: ','
    endif
  endif
%}

{%- comment -%}
  Debug (view page source):
{%- endcomment -%}
<!-- DEBUG page.title: {{ page.title | escape }} -->
<!-- DEBUG custom.collection_handles (raw): {{ page.metafields.custom.collection_handles | json }} -->
<!-- DEBUG custom.collection_handles.value: {{ page.metafields.custom.collection_handles.value | json }} -->
<!-- DEBUG custom.collection_urls (raw): {{ page.metafields.custom.collection_urls | json }} -->
<!-- DEBUG custom.collection_urls.value: {{ page.metafields.custom.collection_urls.value | json }} -->
<!-- DEBUG namespaces on page: {% for ns_pair in page.metafields %}{{ ns_pair[0] }} {% endfor %} -->
<!-- DEBUG handle_list final: {{ handle_list | json }} -->
<!-- DEBUG sanity: collections['soluble-oils'] title => {{ collections['soluble-oils'].title }} -->
<!-- ^^^ change 'soluble-oils' to a handle that definitely exists in your store to verify the collections[] drop -->

<section class="section section--collections-grid" aria-labelledby="collection-grid-heading">
  <div class="container">
    {% if heading != blank or intro != blank or show_page_content %}
      <header class="section__header">
        {% if heading != blank %}
          <h1 id="collection-grid-heading" class="section__title text-h2">{{ heading | escape }}</h1>
        {% endif %}
        {% if intro != blank %}
          <div class="section__intro text-p1">{{ intro }}</div>
        {% endif %}
        {% if show_page_content %}
          <div class="section__content rte">{{ page.content }}</div>
        {% endif %}
      </header>
    {% endif %}

    {% if handle_list and handle_list != blank and handle_list.size > 0 %}
      <div class="collection-grid" role="list">
        {% for handle in handle_list %}
          {% assign handle = handle | strip | downcase %}
          {% assign collection = collections[handle] %}
          {% if collection %}
            {% liquid
              assign summary = collection.metafields.custom.short_description | default: collection.description
              assign collection_image = collection.image
              assign image_alt = ''
              if collection_image and collection_image.alt != blank
                assign image_alt = collection_image.alt
              else
                assign image_alt = collection.title
              endif
            %}
            <article class="collection-card" role="listitem">
              <div class="collection-card__media">
                {% if collection_image %}
                  {{ collection_image | image_url: width: 960 | image_tag: class: 'collection-card__image', loading: 'lazy', widths: '320, 480, 640, 800, 960', sizes: '(min-width: 1080px) 320px, (min-width: 768px) 45vw, 90vw', alt: image_alt, decoding: 'async' }}
                {% else %}
                  <div class="collection-card__placeholder text-p1" role="img" aria-label="{{ collection.title | escape }} image placeholder">Image coming soon</div>
                {% endif %}
              </div>
              <div class="collection-card__body">
                <h2 class="collection-card__title text-h4"><a href="{{ collection.url }}" class="collection-card__link">{{ collection.title }}</a></h2>
                {% if summary != blank %}
                  <p class="collection-card__description text-p1">{{ summary | strip_html }}</p>
                {% endif %}
                <div class="collection-card__actions">
                  <a class="btn btn-primary" href="{{ collection.url }}">{{ button_label | escape }}</a>
                </div>
              </div>
            </article>
          {% else %}
            <!-- DEBUG missing collection for handle: {{ handle }} -->
          {% endif %}
        {% endfor %}
      </div>
    {% else %}
      <p class="collection-grid__empty text-p1" role="status">No collections have been assigned to this page yet.</p>
    {% endif %}
  </div>
</section>

{% schema %}
{
  "name": "Collections grid",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Shop collections" },
    { "type": "richtext", "id": "intro", "label": "Intro text" },
    { "type": "checkbox", "id": "show_page_content", "label": "Show page content", "default": false },
    { "type": "text", "id": "button_label", "label": "Button label", "default": "Shop collection" }
  ],
  "presets": [{ "name": "Collections grid" }]
}
{% endschema %}
