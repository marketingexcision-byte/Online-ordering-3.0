{% liquid
  assign heading = section.settings.heading | default: page.title
  assign intro = section.settings.intro
  assign show_page_content = section.settings.show_page_content and page and page.content != blank
  assign button_label = section.settings.button_label | default: 'Shop collection'

  # ---- Read the Page metafield (List -> Collection) ----
  assign mf = nil
  if page and page.metafields and page.metafields.custom and page.metafields.custom.collection_grid_collections
    assign mf = page.metafields.custom.collection_grid_collections
  endif

  # Normalize to either `items` (actual collection objects) OR `handle_list` (array of handles)
  assign items = blank
  assign handle_list = blank

  # Newer themes: .value => array of collection objects
  if mf and mf.value and mf.value != blank
    assign items = mf.value
  # Some shops: .references => array of reference objects with .value
  elsif mf and mf.references and mf.references != blank
    assign items = mf.references | map: 'value'
  endif

  # Fallback for OS 1.0 where the metafield may not hydrate to objects:
  # Use metafield_tag to get <a href="/collections/handle">â€¦</a> and extract handles.
  if items == blank and mf
    assign tag_html = mf | metafield_tag
    if tag_html and tag_html != blank
      assign pieces = tag_html | split: 'href="'
      assign handles_csv = ''
      for p in pieces
        if forloop.index0 > 0
          assign url = p | split: '"' | first
          assign handle = url | split: '/collections/' | last | split: '?' | first | split: '/' | first
          if handle != blank
            if handles_csv == ''
              assign handles_csv = handle
            else
              assign handles_csv = handles_csv | append: ',' | append: handle
            endif
          endif
        endif
      endfor
      if handles_csv != ''
        assign handle_list = handles_csv | split: ','
      endif
    endif
  endif

  assign have_items = items and items != blank and items.size > 0
  assign have_handles = handle_list and handle_list != blank and handle_list.size > 0
%}


<div class="wrapper">
<section class="section section--collections-grid" aria-labelledby="collection-grid-heading">
  <div class="layout-constrained">
    {% if heading != blank or intro != blank or show_page_content %}
      <header class="section__header">
        {% if heading != blank %}
          <h1 id="collection-grid-heading" class="section__title text-h2">{{ heading | escape }}</h1>
        {% endif %}
        {% if intro != blank %}
          <div class="section__intro text-p1">{{ intro }}</div>
        {% endif %}
        {% if show_page_content %}
          <div class="section__content rte">{{ page.content }}</div>
        {% endif %}
      </header>
    {% endif %}

    {% if have_items or have_handles %}
      <div class="collection-grid" role="list">
        {% if have_items %}
          {% for collection in items %}
            {% liquid
              assign short_description = collection.metafields.custom.short_description
              assign collection_image = collection.image
              assign image_alt = ''
              if collection_image and collection_image.alt != blank
                assign image_alt = collection_image.alt
              else
                assign image_alt = collection.title
              endif
            %}
            <article class="collection-card" role="listitem">
              <div class="collection-card__media">
                {% if collection_image %}
                  {{ collection_image | image_url: width: 960 | image_tag: class: 'collection-card__image', loading: 'lazy', widths: '320, 480, 640, 800, 960', sizes: '(min-width: 1080px) 320px, (min-width: 768px) 45vw, 90vw', alt: image_alt, decoding: 'async' }}
                {% else %}
                  <div class="collection-card__placeholder text-p1" role="img" aria-label="{{ collection.title | escape }} image placeholder">Image coming soon</div>
                {% endif %}
              </div>
              <div class="collection-card__body">
                <h2 class="collection-card__title text-h4"><a href="{{ collection.url }}" class="collection-card__link">{{ collection.title }}</a></h2>
                {% if short_description != blank %}
                  <p class="collection-card__description text-p1">{{ short_description | strip_html }}</p>
                {% endif %}
                <div class="collection-card__actions">
                  <a class="btn btn-primary" href="{{ collection.url }}">{{ button_label | escape }}</a>
                </div>
              </div>
            </article>
          {% endfor %}
        {% else %}
          {% for handle in handle_list %}
            {% assign collection = collections[handle] %}
            {% if collection %}
              {% liquid
                assign short_description = collection.metafields.custom.short_description
                assign collection_image = collection.image
                assign image_alt = ''
                if collection_image and collection_image.alt != blank
                  assign image_alt = collection_image.alt
                else
                  assign image_alt = collection.title
                endif
              %}
              <article class="collection-card" role="listitem">
                <div class="collection-card__media">
                  {% if collection_image %}
                    {{ collection_image | image_url: width: 960 | image_tag: class: 'collection-card__image', loading: 'lazy', widths: '320, 480, 640, 800, 960', sizes: '(min-width: 1080px) 320px, (min-width: 768px) 45vw, 90vw', alt: image_alt, decoding: 'async' }}
                  {% else %}
                    <div class="collection-card__placeholder text-p1" role="img" aria-label="{{ collection.title | escape }} image placeholder">Image coming soon</div>
                  {% endif %}
                </div>
                <div class="collection-card__body">
                  <h2 class="collection-card__title text-h4"><a href="{{ collection.url }}" class="collection-card__link">{{ collection.title }}</a></h2>
                  {% if short_description != blank %}
                    <p class="collection-card__description text-p1">{{ short_description | strip_html }}</p>
                  {% endif %}
                  <div class="collection-card__actions">
                    <a class="btn btn-primary" href="{{ collection.url }}">{{ button_label | escape }}</a>
                  </div>
                </div>
              </article>
            {% endif %}
          {% endfor %}
        {% endif %}
      </div>
    {% else %}
      <div class="collection-grid__empty text-p1">No collections have been assigned to this page yet.</div>
    {% endif %}
  </div>
</section>
</div>
