{% comment %}
  snippets/tab-snippets/Product Data.liquid
  – Condenses Workpiece‐Material tags into one row (P,M,K,N,S,H)
  – Groups other tag_value (_-tags) by key, joining values with ", "
  – Shows fallback if nothing matches
{% endcomment %}

{% assign materials    = '' %}
{% assign handled_tags = '' %}
{% assign has_specs    = false %}

{%- comment -%}
  1) Collect all material codes & mark those tags handled
{%- endcomment -%}
{% for tag in product.tags %}
  {% if tag == 'Carbon Steels_Good'
    or tag == 'Carbon Steels_Great'
    or tag == 'Carbon Steels_Excellent'
    or tag == 'Alloy Steels_Good'
    or tag == 'Alloy Steels_Great'
    or tag == 'Alloy Steels_Excellent'
    or tag == 'High Alloy Steels_Good'
    or tag == 'High Alloy Steels_Great'
    or tag == 'High Alloy Steels_Excellent'
    or tag == 'High Carbon Steels_Good'
    or tag == 'High Carbon Steels_Great'
    or tag == 'High Carbon Steels_Excellent'
    or tag == 'Prehardened Steels_Good'
    or tag == 'Prehardened Steels_Great'
    or tag == 'Prehardened Steels_Excellent'
    or tag == 'Structural Steels_Good'
    or tag == 'Structural Steels_Great'
    or tag == 'Structural Steels_Excellent'
    or tag == 'Mild & Free Machining_Good'
    or tag == 'Mild & Free Machining_Great'
    or tag == 'Mild & Free Machining_Excellent'
    or tag == 'Tool Steels_Good'
    or tag == 'Tool Steels_Great'
    or tag == 'Tool Steels_Excellent'
    or tag == 'High Alloyed_Good'
    or tag == 'High Alloyed_Great'
    or tag == 'High Alloyed_Excellent'
  %}
    {% unless materials contains 'P' %}
      {% assign materials = materials | append: 'P,' %}
    {% endunless %}
    {% assign handled_tags = handled_tags | append: tag | append: ',' %}

  {% elsif tag == 'Structural & Low Carbon Steels_Good'
    or tag == 'Structural & Low Carbon Steels_Great'
    or tag == 'Structural & Low Carbon Steels_Excellent'
    or tag == 'Stainless Steels_Good'
    or tag == 'Stainless Steels_Great'
    or tag == 'Stainless Steels_Excellent'
  %}
    {% unless materials contains 'M' %}
      {% assign materials = materials | append: 'M,' %}
    {% endunless %}
    {% assign handled_tags = handled_tags | append: tag | append: ',' %}

  {% elsif tag == 'Cast Iron_Good'
    or tag == 'Cast Iron_Great'
    or tag == 'Cast Iron_Excellent'
  %}
    {% unless materials contains 'K' %}
      {% assign materials = materials | append: 'K,' %}
    {% endunless %}
    {% assign handled_tags = handled_tags | append: tag | append: ',' %}

  {% elsif tag == 'Aluminium_Good'
    or tag == 'Aluminium_Great'
    or tag == 'Aluminium_Excellent'
    or tag == 'Bronze_Good'
    or tag == 'Bronze_Great'
    or tag == 'Bronze_Excellent'
    or tag == 'Brass Bronze_Good'
    or tag == 'Brass Bronze_Great'
    or tag == 'Brass Bronze_Excellent'
    or tag == 'Copper_Good'
    or tag == 'Copper_Great'
    or tag == 'Copper_Excellent'
    or tag == 'CFRP_Good'
    or tag == 'CFRP_Great'
    or tag == 'CFRP_Excellent'
    or tag == 'Non-ferrous_Good'
    or tag == 'Non-ferrous_Great'
    or tag == 'Non-ferrous_Excellent'
    or tag == 'Aluminum & Aluminum alloy_Good'
    or tag == 'Aluminum & Aluminum alloy_Great'
    or tag == 'Aluminum & Aluminum alloy_Excellent'
    or tag == 'Magnesium & Magnesium Alloys_Good'
    or tag == 'Magnesium & Magnesium Alloys_Great'
    or tag == 'Magnesium & Magnesium Alloys_Excellent'
    or tag == 'Plastic_Good'
    or tag == 'Plastic_Great'
    or tag == 'Plastic_Excellent'
    or tag == 'Acrylic_Good'
    or tag == 'Acrylic_Great'
    or tag == 'Acrylic_Excellent'
  %}
    {% unless materials contains 'N' %}
      {% assign materials = materials | append: 'N,' %}
    {% endunless %}
    {% assign handled_tags = handled_tags | append: tag | append: ',' %}

  {% elsif tag == 'Inconel_Good'
    or tag == 'Inconel_Great'
    or tag == 'Inconel_Excellent'
    or tag == 'Titanium_Good'
    or tag == 'Titanium_Great'
    or tag == 'Titanium_Excellent'
    or tag == 'Nickel_Good'
    or tag == 'Nickel_Great'
    or tag == 'Nickel_Excellent'
  %}
    {% unless materials contains 'S' %}
      {% assign materials = materials | append: 'S,' %}
    {% endunless %}
    {% assign handled_tags = handled_tags | append: tag | append: ',' %}

  {% elsif tag == 'Hardened Steels (HRc40~45)_Good'
    or tag == 'Hardened Steels (HRc40~45)_Great'
    or tag == 'Hardened Steels (HRc40~45)_Excellent'
    or tag == 'Hardened Steels(HRc30~45)_Good'
    or tag == 'Hardened Steels(HRc30~45)_Great'
    or tag == 'Hardened Steels(HRc30~45)_Excellent'
    or tag == 'Hardened Steels(HRc45~)_Good'
    or tag == 'Hardened Steels(HRc45~)_Great'
    or tag == 'Hardened Steels(HRc45~)_Excellent'
    or tag == 'Hardened Steels(HRc45~55)_Good'
    or tag == 'Hardened Steels(HRc45~55)_Great'
    or tag == 'Hardened Steels(HRc45~55)_Excellent'
    or tag == 'High Hardened Steels(HRc55~70)_Good'
    or tag == 'High Hardened Steels(HRc55~70)_Great'
    or tag == 'High Hardened Steels(HRc55~70)_Excellent'
  %}
    {% unless materials contains 'H' %}
      {% assign materials = materials | append: 'H,' %}
    {% endunless %}
    {% assign handled_tags = handled_tags | append: tag | append: ',' %}
  {% endif %}
{% endfor %}

{% comment %} turn our comma-list into an array {% endcomment %}
{% assign codes = materials | split: ',' %}

<div class="excision-accordion">
  <div class="excision-accordion-header">
    <span>Product Data</span>
  </div>

  <div class="excision-accordion-content">
    <table class="excision-spec-table">

      {%- comment -%} Workpiece Material in fixed order {%- endcomment -%}
      {% if materials != '' %}
        {% assign has_specs = true %}
        <tr>
          <td style="width: 35%;">Workpiece Material</td>
          <td style="display:flex; gap:7px; margin-bottom:-1px;">
            {% assign ordered = 'P,M,K,N,S,H' | split: ',' %}
            {% for code in ordered %}
              {% if codes contains code %}
                {% assign has_specs = true %}
                <span class="material material-{{ code }}">{{ code }}</span>
              {% endif %}
            {% endfor %}
          </td>
        </tr>
      {% endif %}

      {%- comment -%} Group & render other spec-tags by key {%- endcomment -%}
      {% assign keys = '' %}
      {% for tag in product.tags %}
        {% if tag contains '_' %}
          {% unless handled_tags contains tag %}
            {% assign key = tag | split: '_' | first %}
            {% unless keys contains key %}
              {% assign keys = keys | append: key | append: '||' %}
            {% endunless %}
          {% endunless %}
        {% endif %}
      {% endfor %}
      {% assign key_list = keys | split: '||' %}

      {% for key in key_list %}
        {% if key != '' %}
          {% assign prefix = key | append: '_' %}
          {% assign joined_values = '' %}
          {% for tag in product.tags %}
            {% if tag contains prefix %}
              {% unless handled_tags contains tag %}
                {% assign val = tag | split: '_' | last %}
                {% if joined_values == '' %}
                  {% assign joined_values = val %}
                {% else %}
                  {% assign joined_values = joined_values | append: ', ' | append: val %}
                {% endif %}
                {% assign has_specs = true %}
              {% endunless %}
            {% endif %}
          {% endfor %}
          <tr>
            <td>{{ key }}</td>
            <td>{{ joined_values }}</td>
          </tr>
        {% endif %}
      {% endfor %}

    </table>

    {% unless has_specs %}
      <p>No specifications available.</p>
    {% endunless %}
  </div>
</div>

<style>
  .excision-accordion-header {
    padding:0px 0px 22px 0px; font-family: 'Humanist777BT-Bold'; font-size:18px;
    display:flex; justify-content:space-between; align-items:center
  }
  .excision-accordion-content { }
  .excision-spec-table { width:100%; border-collapse:collapse; }
  .excision-spec-table td { padding: 15px 15px 15px 0px !important; border-top: 0px solid !important; border-left: 0px solid !important; border-right: 0px solid !important; }
  .material { font-family: 'Humanist777BT-Bold'; border-radius: 5px; color: white; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; }
  .material-P { background:#0069a7 }
  .material-M { background:#f6b519 }
  .material-K { background:#e0592a }
  .material-N { background:#109954 }
  .material-S { background:#f88d2b }
  .material-H { background:#666666 }
</style>
