{% render 'wcp_discount' with product %}
{% assign current_variant = product.selected_or_first_available_variant %}
{% render 'wcp_variant' with current_variant %}

{% assign temp_wcp_v_price = wcp_v_price %}
{% assign temp_wcp_v_compare_at_price = wcp_v_compare_at_price %}
{% unless grid_item_width %}
  {% assign grid_item_width = 'large--one-quarter medium-down--one-half' %}
{% endunless %}

{% unless image_size %}
  {% assign image_size = '600x600' %}
{% endunless %}

{% unless current_collection %}
  {% assign current_collection = collection %}
{% endunless %}

{% assign on_sale = false %}
{% if wcp_compare_at_price > wcp_price %}
  {% assign on_sale = true %}
{% endif %}

<div class="grid-item {{ grid_item_width }}{% if on_sale %} on-sale{% endif %}">
  <a href="{{ product.url | within: current_collection }}" class="product-grid-item">
    <div class="product-grid-image">
      <div class="product-grid-image--centered">
        {% if product.tags contains 'New' %}
          <span class="new-badge font-bold">New</span>
        {% endif %}
        

        {% if product.featured_image %}
          {% assign first_image = product.featured_image %}

          {% if product.images.size > 1 %}
            {% assign second_image = product.images[1] %}
            <div class="product-image-wrapper">
              <!-- First (Default) Image -->
              <img
                class="product-image front lazyload"
                data-src="{{ first_image | img_url: '540x' }}"
                data-widths="[125, 180, 360, 540, 720, 900, 1080, 1296, 1512, 1728, 2048]"
                data-sizes="auto"
                alt="{{ first_image.alt | escape }}"
              >

              <!-- Second (Hover) Image -->
              <img
                class="product-image back lazyload"
                data-src="{{ second_image | img_url: '540x' }}"
                data-widths="[125, 180, 360, 540, 720, 900, 1080, 1296, 1512, 1728, 2048]"
                data-sizes="auto"
                alt="{{ second_image.alt | escape }}"
              >
            </div>
          {% else %}
            <div class="product-image-wrapper" style="transition: none;">
              <!-- Single Image (No Hover Effect) -->
              <img
                class="product-image single lazyload"
                data-src="{{ first_image | img_url: '540x' }}"
                data-widths="[125, 180, 360, 540, 720, 900, 1080, 1296, 1512, 1728, 2048]"
                data-sizes="auto"
                alt="{{ first_image.alt | escape }}"
              >
            </div>
          {% endif %}
        {% else %}
          <div>
            <img
              class="product-placeholder-image"
              src=" https://cdn.shopify.com/s/files/1/0439/5597/8399/files/Excision_Logo_2025.svg?v=1745463654"
              alt="Excision"
            >
          </div>
        {% endif %}
      </div>
    </div>

    <p class="font-bold {% if product.metafields.custom.title.value != blank %} cpgs_title{% endif %}">
      {{ product.title }}
    </p>
    {% if product.metafields.custom.title.value != blank %}
      <span class="secondary--product_title ">{{ product.metafields.custom.title }}</span>
    {% endif %}

<section id="samples-wizard" class="section">
  <div class="container layout-constrained">
    <div class="section__header">
      <h2 class="section__title">Free Samples</h2>
    </div>    

    <div id="sw-app">
      <div class="tabs" role="tablist" aria-label="Progress">
        <button aria-selected="true" data-step="1">1. Your details</button>
        <button aria-selected="false" data-step="2">2. Pick samples</button>
        <button aria-selected="false" data-step="3">3. Review & submit</button>
      </div>

      <!-- Step 1 -->
      <article class="card" data-panel="1">
        <div style="display:grid;grid-template-columns:repeat(12,1fr);gap:16px">
          <div style="grid-column:span 6">
            <label>First name*</label>
            <input class="form-input" id="sw-firstname" required>
          </div>
          <div style="grid-column:span 6">
            <label>Last name*</label>
            <input class="form-input" id="sw-lastname" required>
          </div>
          <div style="grid-column:span 6">
            <label>Email*</label>
            <input class="form-input" id="sw-email" type="email" required>
          </div>
          <div style="grid-column:span 6">
            <label>Mobile phone number*</label>
            <input class="form-input" id="sw-mobilephone" required>
          </div>
          <div style="grid-column:span 12">
            <label>Full Street Address*</label>
            <input class="form-input" id="sw-address" required>
          </div>
          <div style="grid-column:span 12">
            <label>Company name*</label>
            <input class="form-input" id="sw-company" required>
          </div>
          <div style="grid-column:span 12">
            <label>Number of Machines*</label>
            <input class="form-input" id="sw-machines" type="number" min="0" required>
          </div>
          <div style="grid-column:span 12">
            <label>Materials Commonly Machined*</label>
            <textarea class="form-input" id="sw-metals_machining" rows="3"></textarea>
          </div>
        </div>
        <div class="w-btn-wrapper">
          <button class="btn btn-primary" id="sw-next-1">Next</button>
        </div>
        <div id="sw-error-1" style="color:#b00020"></div>
      </article>

<!-- Step 2 (PLAIN LIQUID – NO parse_json) -->
<article class="card" data-panel="2" hidden>
  {% assign cat_blocks = 
    "alu_power_endmill|Alu-Power Endmill|alu-power-1-flute-30-helix-end-mill-e5e47|ALU_ROWS,
     k_2_carbide_endmill|K-2 Carbide Endmill|k2-carbide-endmill|K2_ROWS,
     combo_tap|Combo Tap|hss-e-combo-tap|COMBO_ROWS,
     gold_p_jobber_drill|Gold-P Jobber Drill|gold-p-jobber-drill|GOLDP_ROWS,
     iso_inserts|ISO Inserts|dnmg-insert|ISO_ROWS" | split: "," %}

  {%- comment -%}
    Define rows per category. Each row is "variantId|chipLabel|hs_value"
  {%- endcomment -%}
  {% assign ALU_ROWS = 
    "47931053801701|Ø3.0|Alu-Power 1 Flute | 30° Helix | 3 x 3 x 12 x 50mm (E5E47030),
     47931053834469|Ø4.0|Alu-Power 1 Flute | 30° Helix | 4 x 4 x 15 x 60mm (E5E47040),
     47931053900005|Ø6.0|Alu-Power 1 Flute | 30° Helix | 6 x 6 x 20 x 65mm (E5E47060),
     47931053932773|Ø8.0|Alu-Power 1 Flute | 30° Helix | 8 x 8 x 22 x 65mm (E5E47080)" | split: "," %}

  {% assign K2_ROWS = 
    "55555555555555|Ø3.0|K-2 Carbide 2 Flute | 30° | Short | 3 x 3 x 12 x 32mm (G9424030),
     66666666666666|Ø6.0|K-2 Carbide 4 Flute | 30° | Short | 6 x 6 x 16 x 50mm (G9432060),
     77777777777777|Ø8.0|K-2 Carbide 4 Flute | 30° | Short | 8 x 8 x 20 x 60mm (G9432080)" | split: "," %}

  {% assign COMBO_ROWS = 
    "88888888888888|M4 x 0.7|HSS-E Combo Tap | DIN371 | Spiral Flute | M4 x 0.7 6H 63.0L (TC804246),
     99999999999999|M8 x 1.25|HSS-E Combo Tap | DIN371 | Gun Point | M8 x 1.25 6H 90.0L (TC814366)" | split: "," %}

  {% assign GOLDP_ROWS =
    "12312312312312|Ø3.3|Gold-P Jobber Drill | DIN338/N | 3.3 x 36 x 65mm (DLGP195033),
     12412412412412|Ø6.8|Gold-P Jobber Drill | DIN338/N | 6.8 x 69 x 109mm (DLGP195068)" | split: "," %}

  {% assign ISO_ROWS =
    "13513513513513|DNMG150604-UF-YG3030|DNMG150604-UF-YG3030/DNMG441-UF (22000227)" | split: "," %}

  {% for raw in cat_blocks %}
    {% assign parts = raw | strip | split: "|" %}
    {% assign cat_key = parts[0] %}
    {% assign cat_label = parts[1] %}
    {% assign handle = parts[2] %}
    {% assign rows_var = parts[3] %}

    <h3 class="section__title" style="margin:.5rem 0 1rem">{{ cat_label }}</h3>

    {% assign p = all_products[handle] %}
    {% if p %}
      <div class="grid-uniform products-collection rlp_regular" data-category="{{ cat_key }}">
        <div class="sw-card-wrap" data-product-handle="{{ p.handle }}">
          {% render 'product-grid-item-samples', product: p %}

          <div class="card-variants">
            <div class="card-variants-label">Choose variant</div>
            <div class="card-variants-chips">
              {% assign rows = nil %}
              {% case rows_var %}
                {% when 'ALU_ROWS' %}{% assign rows = ALU_ROWS %}
                {% when 'K2_ROWS' %}{% assign rows = K2_ROWS %}
                {% when 'COMBO_ROWS' %}{% assign rows = COMBO_ROWS %}
                {% when 'GOLDP_ROWS' %}{% assign rows = GOLDP_ROWS %}
                {% when 'ISO_ROWS' %}{% assign rows = ISO_ROWS %}
              {% endcase %}

              {% for r in rows %}
                {% assign cols = r | strip | split: "|" %}
                {% assign vid  = cols[0] | strip %}
                {% assign lab  = cols[1] | strip %}
                {% assign hs   = cols[2] | strip %}
                {%- assign v = nil -%}

{%- comment %} try numeric where first {%- endcomment -%}
{%- assign wanted_num = vid | plus: 0 -%}
{%- assign v = p.variants | where: 'id', wanted_num | first -%}

{%- if v == nil -%}
  {%- comment %} fallback . compare as strings to avoid type issues {%- endcomment -%}
  {%- assign target = vid | append: '' -%}
  {%- for cand in p.variants -%}
    {%- assign cid = cand.id | append: '' -%}
    {%- if cid == target -%}
      {%- assign v = cand -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

                {% if v %}
                  <button type="button"
                          class="variant-chip sw-select-variant"
                          data-hs-prop="{{ cat_key }}"
                          data-hs-value="{{ hs | escape }}"
                          data-variant-id="{{ v.id }}"
                          data-variant-sku="{{ v.sku | escape }}">
                    {{ lab }}
                  </button>
                {% else %}
                  <span class="variant-chip variant-chip--more">Missing variant {{ lab }}</span>
                {% endif %}
              {% endfor %}
            </div>
          </div>

          <div class="w-btn-wrapper">
            <button class="btn btn-outline sw-select-btn" data-category="{{ cat_key }}">Confirm selection</button>
          </div>
        </div>
      </div>
    {% else %}
      <div class="card">Missing product handle: <code>{{ handle }}</code></div>
    {% endif %}
  {% endfor %}

  <div class="w-btn-wrapper" style="display:flex;gap:12px">
    <button class="btn btn-outline" id="sw-back-2">Back</button>
    <button class="btn btn-primary" id="sw-next-2">Review</button>
  </div>
</article>


      <!-- Step 3 -->
      <article class="card" data-panel="3" hidden>
        <h3 class="section__title">Review</h3>
        <div id="sw-review"></div>
        <div class="w-btn-wrapper">
          <button class="btn btn-outline" id="sw-back-3">Back</button>
          <button class="btn btn-primary full-width" id="sw-submit">Send me samples</button>
        </div>
        <div id="sw-error-3" style="color:#b00020"></div>
        <div id="sw-success" class="card" style="display:none;background:#ecfdf5;border-color:#10b981;color:#064e3b">
          Thanks. we’ve got it.
        </div>
      </article>
    </div>
  </div>

  <script>
  (function(){
    const HUBSPOT = {
      portalId: "2595431",
      formGuid: "30c37b27-b6db-444a-9872-19ddb7e78b89",
      workerEndpoint: "https://samples-hs-submit.marketingexcision.workers.dev/",
      redirectUrl: "/pages/thank-you"
    };

    const FIELD_MAP = {
      firstname: "firstname",
      lastname: "lastname",
      email: "email",
      mobilephone: "mobilephone",
      address: "address",
      company: "company",
      machines: "machines",
      metals_machining: "metals_machining",
      products: {
        alu_power_endmill: "alu_power_endmill",
        k_2_carbide_endmill: "k_2_carbide_endmill",
        combo_tap: "combo_tap",
        gold_p_jobber_drill: "gold_p_jobber_drill",
        iso_inserts: "iso_inserts"
      }
    };

    const state = { step:1, contact:{}, selections:{} };
    const $ = s => document.querySelector(s);
    const $$ = (s,root=document) => Array.from(root.querySelectorAll(s));

    function setStep(n){
      state.step = n;
      $$('.tabs button').forEach((b,i)=> b.setAttribute('aria-selected', String(i+1===n)));
      $$('article.card[data-panel]').forEach(p => p.hidden = (Number(p.dataset.panel)!==n));
      if(n===3) renderReview();
    }

    $('#sw-next-1').addEventListener('click', () => {
      const get = id => $(id).value.trim();
      const req = ['#sw-firstname','#sw-lastname','#sw-email','#sw-mobilephone','#sw-address','#sw-company','#sw-machines'];
      if(req.some(sel => !$(sel).value.trim())){ $('#sw-error-1').textContent='Fill the required fields first.'; return; }
      $('#sw-error-1').textContent='';
      state.contact = {
        firstname: get('#sw-firstname'), lastname: get('#sw-lastname'), email: get('#sw-email'),
        mobilephone: get('#sw-mobilephone'), address: get('#sw-address'), company: get('#sw-company'),
        machines: get('#sw-machines'), metals_machining: get('#sw-metals_machining')
      };
      setStep(2);
    });

    $('#sw-back-2').addEventListener('click', ()=> setStep(1));
    $('#sw-next-2').addEventListener('click', ()=> setStep(3));
    $('#sw-back-3').addEventListener('click', ()=> setStep(2));

     // state.selections[cat] = { variantId, sku, hsValue }
  const catSections = document.querySelectorAll('.grid-uniform.products-collection');

  catSections.forEach(section => {
    const cat = section.dataset.category;

    // choose a chip
    section.addEventListener('click', e => {
      const chip = e.target.closest('.sw-select-variant');
      if (!chip) return;

      // set active visual within the same card
      const wrap = chip.closest('.sw-card-wrap');
      wrap.querySelectorAll('.sw-select-variant').forEach(c => c.classList.remove('is-active'));
      chip.classList.add('is-active');

      // stash the pending pick on the card
      wrap.dataset.pendingVariantId = chip.dataset.variantId;
      wrap.dataset.pendingSku = chip.dataset.variantSku || '';
      wrap.dataset.pendingHsValue = chip.dataset.hsValue;
    });

    // confirm selection for the category
    section.addEventListener('click', e => {
      const btn = e.target.closest('.sw-select-btn');
      if (!btn) return;

      const wrap = btn.closest('.sw-card-wrap');
      const vid = wrap.dataset.pendingVariantId;
      const hsValue = wrap.dataset.pendingHsValue;

      if (!vid || !hsValue) {
        alert('Pick a variant first.');
        return;
      }

      // lock this selection at category level
      state.selections[cat] = {
        variantId: vid,
        sku: wrap.dataset.pendingSku || '',
        value: hsValue
      };

      // highlight the chosen card for the category
      section.querySelectorAll('.sw-card-wrap').forEach(w => w.style.outline='none');
      wrap.style.outline = '2px solid var(--color-primary-blue)';
    });
  });

    function renderReview(){
      const c = state.contact, s = state.selections;
      $('#sw-review').innerHTML = `
        <div><strong>Contact</strong><br>
        ${c.firstname||''} ${c.lastname||''} · ${c.email||''}<br>
        ${c.mobilephone||''} · ${c.address||''}<br>
        ${c.company||''} · Machines: ${c.machines||''}<br>
        Materials: ${c.metals_machining||''}</div>
        <hr style="margin:12px 0">
        <div><strong>Samples</strong><ul style="margin:.5rem 0">
          ${Object.entries(FIELD_MAP.products).map(([k,_]) => {
            const v = s[k]?.value || '—';
            const label = k.replaceAll('_',' ').replace('k 2','K-2');
            return `<li>${label}: ${v}</li>`;
          }).join('')}
        </ul></div>`;
    }

    function buildPayload(){
      const fields = [];
      const c = state.contact;
      Object.keys(FIELD_MAP).forEach(k=>{
        if(k==='products') return;
        fields.push({ name: FIELD_MAP[k], value: String(c[k]||'') });
      });
      Object.entries(FIELD_MAP.products).forEach(([cat, prop])=>{
        const val = state.selections[cat]?.value || '';
        fields.push({ name: prop, value: val });
      });
      const hutk = document.cookie.split('; ').find(c=>c.startsWith('hubspotutk='))?.split('=')[1];
      return {
        portalId: HUBSPOT.portalId,
        formGuid: HUBSPOT.formGuid,
        fields,
        context: { hutk, pageUri: location.href, pageName: document.title }
      };
    }

    $('#sw-submit').addEventListener('click', async ()=>{
      try{
        $('#sw-error-3').textContent = '';
        const res = await fetch(HUBSPOT.workerEndpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(buildPayload()) });
        if(!res.ok) throw new Error(await res.text());
        $('#sw-success').style.display='block';
        if(HUBSPOT.redirectUrl) setTimeout(()=> location.href=HUBSPOT.redirectUrl, 900);
      }catch(err){
        $('#sw-error-3').textContent = 'Submission failed: ' + (err.message||err);
      }
    });

    setStep(1);
  })();
  </script>
</section>

<style>
  .sw-select-variant.is-active {
    border-color: var(--color-primary-blue);
    box-shadow: 0 0 0 2px rgba(0,105,167,.12);
  }
</style>



      <style>
                  .product-item--price small {
                    font-size: 18px;
                  }
                  .product-item--price small:hover {
                    color: black;
                  }
                  div.product-item--price {
                    text-align: left;
                  }
                  .product-item--price span {
                    display: flex;
                    line-height: unset;
                    flex-direction: column;
                  }
                  a:hover {
                    color: unset;
                  }
                  /* default: no footprint */
        .icon-container{
          min-height: 0;
          position: absolute;
        }

        /* show + space only when it actually has element children */
        .icon-container:has(> *){
          position: relative;
        }

        /* fallback for older browsers; may miss whitespace-only nodes */
        .icon-container:empty{ display:none; }

        .card-variants {
          margin-bottom: 15px;
        }

        .card-variants-label {
            font-size: 16px !important;
            font-weight: 400 !important;
            color: #666666;
            margin-bottom: 7px !important;
            text-align: start;
        }

        .card-variants-chips {
          display: flex;
          flex-wrap: wrap;
          gap: 9px;
        }

        .variant-chip {
            padding: 8px 12px;
            border: 2px solid #e8e8e8;
            border-radius: 99px;
            white-space: nowrap;
            line-height: 1;
            min-height: 40px;
            align-content: center;
        }

        .variant-chip--more {
            color: #666666;
            border: 2px solid #f1f1f1;
        }
      </style>

      </a>

</div>

  <style>
    /* Ensure the hover effect only applies to the image container */
    .product-image-wrapper {
      position: relative;
      overflow: hidden;
      width: 100%;
      height: 100%;
      padding-top: 100%; /* Maintain aspect ratio */
    }

    .product-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: none !important;
    }

    /* Default image visible, second image hidden */
    .product-image.front {
      opacity: 1;
      z-index: 2;
    }

    .product-image.back {
      opacity: 0;
      z-index: 100;
      transform: scale(1.04);
    }

    /* Hide default image and show hover image on hover */
    .product-grid-item:hover .product-image-wrapper .product-image.front {
      opacity: 0 !important;
    }

    .product-grid-item:hover .product-image-wrapper .product-image.back {
      opacity: 1 !important;
      transform: scale(1);
      transition: 0.3s ease !important;

    }

    /* Single image stays visible without hover effect */
    .product-image.single {
      opacity: 1;
      z-index: 2;
    }
  </style>