{% if request.page_type == 'blog' and blog.all_tags.size > 0 %}
  {% assign categories = '' %}
  {% for tag in blog.all_tags %}
    {% if tag contains '_' %}
      {% capture categories %}{% unless categories == blank  %}{{ categories }}|{% endunless %}{{ tag | split: '_' | first }}{% endcapture %}
    {% endif %}
  {% endfor %}
  {% assign cat_array = categories | split: '|' | uniq %}
{% endif %}

{% if blog.all_tags.size > 0 %}
<div class="grid-uniform"> 
   {%- for cat_item in cat_array -%}
   <div class="grid-item small--one-whole medium--one-third toogle-filters sidebar-items-{{ cat_item }}"> 
      <h2 class="accordion">{{ cat_item }} <span><i class='fa fa-angle-down'></i></span></h2>
      <ul id="matchKey-{{ cat_item }}" class="advanced-filters panel_1">
         <div class="af-panel-body">
           <input type="text" class="txtInput form-control" id="searchTheKey-{{ cat_item }}" placeholder="Search {{ cat_item }}">
           <span class="af-filter-clear af_filter_clear-{{ cat_item }}" style="display:none;">Ã—</span>
         </div> 
         {%- comment -%}
         Loop through collection tags 
         {%- endcomment -%}
         {%- for tag in blog.all_tags -%}
         {%- assign cat = tag | split: '_' | first -%}
         {%- if cat != tag and cat_item == cat -%}
         {%- comment -%}
         Strip out tag category prefix and add/remove link for tag filtering
         {%- endcomment -%}
         {%- if current_tags contains tag -%}
         <li class="advanced-filter active-filter" data-group="{{ cat_item }}" data-handle="{{ tag | handle }}">{{ tag | remove_first: cat_item | remove_first: '_' | link_to_remove_tag: tag }}</li>
         {%- else -%}
         <li class="advanced-filter" data-group="{{ cat_item }}" data-handle="{{ tag | handle }}">{{ tag | remove_first: cat_item | remove_first: '_' | link_to_add_tag: tag }}</li>
         {%- endif -%}
         {%- endif -%}
         {%- endfor -%}
      </ul>
   </div>
   
   <script> 
    $("#searchTheKey-{{ cat_item }}").on('keyup', function(){      
        var value = $(this).val().toLowerCase();
        $("#matchKey-{{ cat_item }} li").each(function () {
            if ($(this).text().toLowerCase().search(value) > -1) {
                $(this).show();
                $(".af_filter_clear-{{ cat_item }}").hide();
                $(this).prev('.subjectName').last().hide();
                } else {
                $(this).hide();
                $(".af_filter_clear-{{ cat_item }}").show();
            }
        });
    });
     
    $(document).ready(function() {
       $(".af_filter_clear-{{ cat_item }}").on('click', function () {
           $("#matchKey-{{ cat_item }} li").show();        
           $("#searchTheKey-{{ cat_item }}").val('');
           $(this).hide();
       });
       var liCount = $("#matchKey-{{ cat_item }}").find("li").length;
       if (liCount > 19){
          $("#matchKey-{{ cat_item }}").addClass("af_overflow_scroll");
       }
       $("#matchKey-{{ cat_item }} li.active-filter").parents('ul').css("display", "block");
       $("#matchKey-{{ cat_item }} li.active-filter").parents('ul').prev('h2').addClass("active");  

       if ( $(window).width() > 768 ) { 
         $(".blog-filter-sidebar > .grid-uniform > .grid-item > h2.accordion").addClass("active");
         $(".blog-filter-sidebar > .grid-uniform > .grid-item > .advanced-filters").css("display", "block");
       }
    }); 
  </script>  
  {%- endfor -%} 
</div> 
  
<script>
   $(function() {
     var filters = $('.advanced-filter'),
       el,
       elGroup,
       elHandle,
       activeTagInGroup;
   
     filters.on('click', function(e) {
       el = $(this);
       elGroup = el.data('group');
       elHandle = el.data('handle');
       activeTagInGroup = $('.active-filter[data-group="'+ elGroup +'"]');
       // If the tag clicked is not already active and its group contains an active tag, we will swap tag within the group.
       if ( !el.hasClass('active-filter')  && activeTagInGroup.size() ) {
         e.preventDefault();
         location.href = location.href
           // swap tag
           .replace(activeTagInGroup.data('handle'), elHandle)
           // go back to page 1
           .replace(/(&page=\d+)|(page=\d+&)|(\?page=\d+$)/, ''); 
       }
     });
   });
</script> 
{% endif %}
