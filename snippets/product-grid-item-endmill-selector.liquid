{% render 'wcp_discount' with product %}
{% assign current_variant = product.selected_or_first_available_variant %}
{% render 'wcp_variant' with current_variant %}

{% assign temp_wcp_v_price = wcp_v_price %}
{% assign temp_wcp_v_compare_at_price = wcp_v_compare_at_price %}
{% unless grid_item_width %}
  {% assign grid_item_width = 'large--one-quarter medium-down--one-half' %}
{% endunless %}

{% unless image_size %}
  {% assign image_size = '600x600' %}
{% endunless %}

{% unless current_collection %}
  {% assign current_collection = collection %}
{% endunless %}

{% assign on_sale = false %}
{% if wcp_compare_at_price > wcp_price %}
  {% assign on_sale = true %}
{% endif %}

<div class="grid-item {{ grid_item_width }}{% if on_sale %} on-sale{% endif %}">
  <a href="{{ product.url | within: current_collection }}"
   class="product-grid-item"
   data-variant-id="{{ current_variant.id }}">
    <div class="product-grid-image">
      <div class="product-grid-image--centered">
        {% if product.tags contains 'New'%}
          <span class="new-badge font-bold">New</span>
        {% endif %}
        {% if product.tags contains 'YG-1' %}
          <div
            class="yg-logo-wrapper"
            style="position: absolute; top: 0; right: 0; z-index: 10; padding: 15px; background: #d52e30; border-radius: 0px 15px;"
          >
            <img
              src="https://cdn.shopify.com/s/files/1/0439/5597/8399/files/YG_Logo_White.png?v=1748387180"
              alt="YG-1 Logo"
              class="yg-logo"
              style="max-width: 50px; height: auto;"
              width="50px"
            >
          </div>
        {% endif %}

        {% if product.featured_image %}
          {% assign first_image = product.featured_image %}

          {% if product.images.size > 1 %}
            {% assign second_image = product.images[1] %}
            <div class="product-image-wrapper">
              <!-- First (Default) Image -->
              <img
                class="product-image front lazyload"
                data-src="{{ first_image | img_url: '540x' }}"
                data-widths="[125, 180, 360, 540, 720, 900, 1080, 1296, 1512, 1728, 2048]"
                data-sizes="auto"
                alt="{{ first_image.alt | escape }}"
              >

              <!-- Second (Hover) Image -->
              <img
                class="product-image back lazyload"
                data-src="{{ second_image | img_url: '540x' }}"
                data-widths="[125, 180, 360, 540, 720, 900, 1080, 1296, 1512, 1728, 2048]"
                data-sizes="auto"
                alt="{{ second_image.alt | escape }}"
              >
            </div>
          {% else %}
            <div class="product-image-wrapper" style="transition: none;">
              <!-- Single Image (No Hover Effect) -->
              <img
                class="product-image single lazyload"
                data-src="{{ first_image | img_url: '540x' }}"
                data-widths="[125, 180, 360, 540, 720, 900, 1080, 1296, 1512, 1728, 2048]"
                data-sizes="auto"
                alt="{{ first_image.alt | escape }}"
              >
            </div>
          {% endif %}
        {% else %}
          <div>
            <img
              class="product-placeholder-image"
              src=" https://cdn.shopify.com/s/files/1/0439/5597/8399/files/Excision_Logo_2025.svg?v=1745463654"
              alt="Excision"
            >
          </div>
        {% endif %}
      </div>
    </div>

    <p class="font-bold {% if product.metafields.custom.title.value != blank %} cpgs_title{% endif %}">
      {{ product.title }}
    </p>

{%- comment -%} Clean ops list for JS hydration {%- endcomment -%}
{%- assign ops_human = '' -%}
{%- for t in product.tags -%}
  {%- assign tdown  = t | downcase -%}
  {%- assign prefix = tdown | slice: 0, 10 -%}
  {%- if prefix == 'operation_' -%}
    {%- assign nice = t | replace_first: 'Operation_', '' | replace: '_', ' ' -%}
    {%- if ops_human != '' -%}{%- assign ops_human = ops_human | append: ', ' -%}{%- endif -%}
    {%- assign ops_human = ops_human | append: nice -%}
  {%- endif -%}
{%- endfor -%}
<span data-vqs-source="ops" data-ops="{{ ops_human | escape }}" style="display:none;"></span>



    
    <div class="product-item--price">
<span class="medium--left">
  {%- assign v = current_variant -%}
  {%- assign taxable = v.taxable | default: true -%}

  {%- if v.price > 0 -%}
    {%- assign inc = v.price -%}
    {%- assign ex  = v.price -%}
    {%- if taxable -%}
      {%- if shop.taxes_included -%}
        {%- assign inc = v.price -%}
        {%- assign ex  = v.price | times: 10 | divided_by: 11 -%}
      {%- else -%}
        {%- assign ex  = v.price -%}
        {%- assign inc = v.price | times: 11 | divided_by: 10 -%}
      {%- endif -%}
    {%- endif -%}

    <span class="ex-price ex-price--stack">
      <strong class="ex-price__inc">{{ inc | money }}<span class="inc-price__label">INC GST</span></strong>
      {%- if taxable -%}
        <div class="ex-price__ex">{{ ex | money }} <span class="ex-price__label">EX GST</span></div>
      {%- endif -%}
    </span>
  {%- else -%}
    <span class="ex-price ex-price--stack from-price">
      <strong class="ex-price__inc">Pricing available on request</strong>
    </span>
  {%- endif -%}
</span>


      <style>
                  .product-item--price small {
                    font-size: 18px;
                  }
                  .product-item--price small:hover {
                    color: black;
                  }
                  div.product-item--price {
                    text-align: left;
                  }
                  .product-item--price span {
                    display: flex;
                    line-height: unset;
                    flex-direction: column;
                  }
                  a:hover {
                    color: unset;
                  }
                  /* default: no footprint */
        .icon-container{
          min-height: 0;
          position: absolute;
        }

        /* show + space only when it actually has element children */
        .icon-container:has(> *){
          position: relative;
        }

        /* fallback for older browsers; may miss whitespace-only nodes */
        .icon-container:empty{ display:none; }
      
        .card-variants {
          margin-bottom: 15px;
        }

        .card-variants-label {
            font-size: 16px !important;
            font-weight: 400 !important;
            color: #666666;
            margin-bottom: 7px !important;
            text-align: start;
        }

        .card-variants-chips {
          display: flex;
          flex-wrap: wrap;
          gap: 9px;
        }

        .variant-chip {
            padding: 8px 12px;
            border: 2px solid #e8e8e8;
            border-radius: 99px;
            white-space: nowrap;
            line-height: 1;
            min-height: 40px;
            align-content: center;
        }

        .variant-chip--more {
            color: #666666;
            border: 2px solid #f1f1f1;
        }
      </style>

      {% if product.selected_or_first_available_variant.available
        and product.selected_or_first_available_variant.unit_price_measurement
      %}
        {% render 'product-unit-price', variant: product.selected_or_first_available_variant %}
      {% endif %}
    </div>

{% render 'auto-discount-note', product: product %}

{%- comment -%} ==== VARIANT QUICK GLANCE (variant-scoped) ==== {%- endcomment -%}
{%- assign v = current_variant -%}

{%- comment -%} Resolve option indexes robustly {%- endcomment -%}
{%- assign idx_dia  = nil -%}
{%- assign idx_rad  = nil -%}
{%- assign idx_shnk = nil -%}
{%- for opt in product.options_with_values -%}
  {%- assign nm = opt.name | strip -%}
  {%- if nm == 'Mill Diameter (mm)'    -%}{%- assign idx_dia  = forloop.index0 -%}{%- endif -%}
  {%- if nm == 'Corner Radius (mm)'    -%}{%- assign idx_rad  = forloop.index0 -%}{%- endif -%}
  {%- if nm == 'Shank Diameter (mm)'   -%}{%- assign idx_shnk = forloop.index0 -%}{%- endif -%}
{%- endfor -%}

{%- assign val_dia = v.options[idx_dia]  | default: blank -%}
{%- assign val_rad = '' -%}{%- if idx_rad  != nil -%}{%- assign val_rad  = v.options[idx_rad]  | default: '' -%}{%- endif -%}
{%- assign val_sho = '' -%}{%- if idx_shnk != nil -%}{%- assign val_sho = v.options[idx_shnk] | default: '' -%}{%- endif -%}

{%- comment -%} Variant metafields {%- endcomment -%}
{%- assign mf_shank = v.metafields.filter.shank_diameter_mm | default: v.metafields.filter['shank_diameter_mm'] -%}
{%- assign mf_loc   = v.metafields.custom.length_of_cut_mm    | default: v.metafields.custom['length_of_cut_mm'] -%}

{%- comment -%} Effective shank: prefer metafield. fall back to option value {%- endcomment -%}
{%- assign val_shank = mf_shank | default: val_sho -%}

{%- comment -%} Operation tags → human list {%- endcomment -%}
{%- assign ops_human = '' -%}
{%- for t in product.tags -%}
  {%- assign tdown  = t | downcase -%}
  {%- assign prefix = tdown | slice: 0, 10 -%}
  {%- if prefix == 'operation_' -%}
    {%- assign nice = t | replace_first: 'Operation_', '' | replace: '_', ' ' -%}
    {%- if ops_human != '' -%}{%- assign ops_human = ops_human | append: ', ' -%}{%- endif -%}
    {%- assign ops_human = ops_human | append: nice -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%} Chamfer Angle from tag Chamfer Angle_<val> → show with ° {%- endcomment -%}
{%- assign chamfer_angle = '' -%}
{%- for t in product.tags -%}
  {%- assign tdown = t | downcase -%}
  {%- assign pref  = tdown | slice: 0, 14 -%}
  {%- if pref == 'chamfer angle_' -%}
    {%- assign chamfer_angle = t | remove_first: 'Chamfer Angle_' -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%} Flutes from tag No. Flutes_<val> {%- endcomment -%}
{%- assign flutes = '' -%}
{%- for t in product.tags -%}
  {%- assign tdown = t | downcase -%}
  {%- assign pref  = tdown | slice: 0, 11 -%} {# 'no. flutes_' length 11 #}
  {%- if pref == 'no. flutes_' -%}
    {%- assign flutes = t | remove_first: 'No. Flutes_' -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%} Workpiece materials via VDI good/excellent → ISO letters P M K N S H {%- endcomment -%}
{%- assign vdi_g_raw = product.metafields.custom.vdi_good      | default: '' -%}
{%- assign vdi_x_raw = product.metafields.custom.vdi_excellent | default: '' -%}
{%- assign vdi_s = vdi_g_raw | append: ',' | append: vdi_x_raw
  | replace: '[', '' | replace: ']', '' | replace: '"', '' | replace: ' ', '' -%}
{%- assign vdi_list = vdi_s | split: ',' -%}

{%- assign seen_str = '' -%}
{%- assign letters_pipes = '' -%}
{%- for raw in vdi_list -%}
  {%- assign n = raw | strip | plus: 0 -%}
  {%- assign iso = '' -%}
  {%- if n >=  1 and n <= 11 -%}{%- assign iso = 'P' -%}{%- endif -%}
  {%- if n >= 12 and n <= 14 -%}{%- assign iso = 'M' -%}{%- endif -%}
  {%- if n >= 15 and n <= 20 -%}{%- assign iso = 'K' -%}{%- endif -%}
  {%- if n >= 21 and n <= 30 -%}{%- assign iso = 'N' -%}{%- endif -%}
  {%- if n >= 31 and n <= 37 -%}{%- assign iso = 'S' -%}{%- endif -%}
  {%- if n >= 38 and n <= 41 -%}{%- assign iso = 'H' -%}{%- endif -%}

  {%- if iso != '' -%}
    {%- unless seen_str contains iso -%}
      {%- assign seen_str = seen_str | append: iso -%}
      {%- if letters_pipes != '' -%}
        {%- assign letters_pipes = letters_pipes | append: '|' -%}
      {%- endif -%}
      {%- assign letters_pipes = letters_pipes | append: iso -%}
    {%- endunless -%}
  {%- endif -%}
{%- endfor -%}
{%- assign mats = letters_pipes | split: '|' -%}


<div class="variant-quick-specs">
  <div class="vqs-row">
    {%- if v.sku != blank -%}
      <div class="vqs-col"><small>Product Code</small><div class="vqs-val">{{ v.sku }}</div></div>
    {%- endif -%}

    {%- if val_dia != blank -%}
      <div class="vqs-col"><small>Mill Diameter</small><div class="vqs-val">{{ val_dia }} mm</div></div>
    {%- endif -%}

    {%- if val_shank != blank -%}
      <div class="vqs-col"><small>Shank Diameter</small><div class="vqs-val">{{ val_shank }} mm</div></div>
    {%- endif -%}

    {%- if val_rad != blank -%}
      <div class="vqs-col"><small>Corner Radius</small><div class="vqs-val">{{ val_rad }} mm</div></div>
    {%- endif -%}

    {%- if mf_loc != blank -%}
      <div class="vqs-col"><small>Length of Cut</small><div class="vqs-val">{{ mf_loc }} mm</div></div>
    {%- endif -%}

    {%- if chamfer_angle != blank -%}
      <div class="vqs-col"><small>Chamfer Angle</small><div class="vqs-val">{{ chamfer_angle }}°</div></div>
    {%- endif -%}

    {%- if flutes != blank -%}
      <div class="vqs-col"><small>Flutes</small><div class="vqs-val">{{ flutes }}</div></div>
    {%- endif -%}

    {%- if ops_human != blank -%}
      <div class="vqs-col vqs-ops"><small>Operation</small><div class="vqs-val">{{ ops_human }}</div></div>
    {%- endif -%}

    {%- if mats.size > 0 and mats.first != '' -%}
      <div class="vqs-col"><small>Workpiece Materials</small>
        <div class="vqs-val vqs-mats">
          {%- for m in mats -%}
            <span class="material material-{{ m }}">{{ m }}</span>
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}

    <div class="vqs-col"><small>Stock</small>
      <div class="vqs-val">
        {%- assign status = '' -%}
        {%- capture status_text -%}
          {%- if v.inventory_management -%}
            {%- assign qty = v.inventory_quantity | default: 0 -%}
            {%- if qty > 5 -%}{%- assign status = 'green' -%}In stock
            {%- elsif qty > 0 -%}{%- assign status = 'orange' -%}Low stock
            {%- else -%}
              {%- if v.incoming and v.next_incoming_date -%}
                {%- assign status = 'blue' -%}Restocking
              {%- elsif v.inventory_policy == 'continue' -%}
                {%- if product.tags contains 'YG-1' -%}{%- assign status = 'yellow' -%}5 days
                {%- else -%}{%- assign status = 'red' -%}Order in{%- endif -%}
              {%- else -%}
                {%- assign status = 'red' -%}No stock
              {%- endif -%}
            {%- endif -%}
          {%- else -%}
            {%- assign status = 'grey' -%}Quantity unavailable
          {%- endif -%}
        {%- endcapture -%}
        <span class="ex-card-badge" data-status="{{ status | strip }}">{{ status_text | strip }}</span>
      </div>
    </div>
  </div>
</div>


{%- comment -%} Per-variant payload for client hydration {%- endcomment -%}
<script type="application/json" class="vmap">
[
  {%- for v in product.variants -%}
  {
    "id": {{ v.id }},
    "sku": {{ v.sku | json }},
    "price": {{ v.price | default: 0 }},
    "compare": {{ v.compare_at_price | default: 0 }},
    "available": {{ v.available | json }},
    "inventory_management": {{ v.inventory_management | json }},
    "inventory_quantity": {{ v.inventory_quantity | default: 0 }},
    "inventory_policy": {{ v.inventory_policy | json }},
    "incoming": {{ v.incoming | json }},
    "next_incoming_date": {{ v.next_incoming_date | date: "%s" | default: 'null' }},
    "options": [{% for o in v.options %}{{ o | json }}{% unless forloop.last %},{% endunless %}{% endfor %}],
    "mf": {
      "shank": {{ v.metafields.filter.shank_diameter_mm | default: v.metafields.filter['shank_diameter_mm'] | json }},
      "loc":   {{ v.metafields.custom.length_of_cut_mm  | default: v.metafields.custom['length_of_cut_mm']  | json }}
    }
  }{% unless forloop.last %},{% endunless %}
  {%- endfor -%}
]
</script>


    {% if section.settings.product_reviews_enable %}
      <span class="shopify-product-reviews-badge" data-id="{{ product.id }}"></span>
    {% endif %}

  </a>

  <div class="payment-buttons payment-buttons--medium form-payment-buttons">
    {% assign first_avail = product.selected_or_first_available_variant | default: product.first_available_variant %}
    {% assign _price_cents = first_avail.price | default: product.price | plus: 0 %}

    {% if product.tags contains 'Custom Length' %}
      <!-- Custom-length products must be configured on the PDP -->
      <a href="{{ product.url }}" class="btn btn--wide btn--buyNow" style="background:#f88d2b;color:#fff;">
        <span style="display:flex;align-items:center;gap:10px;"> Select your blade </span>
      </a>

    {% else %}
      {% if _price_cents == 0 %}
        <!-- $0.00 → send them to PDP to request a quote -->
        <a href="{{ product.url }}" class="btn btn--wide btn--buyNow is-quote" style="background:#f88d2b;color:#fff;">
          <span style="display:flex;align-items:center;gap:10px;"> Request Quote </span>
        </a>
      {% elsif first_avail %}
        <!-- normal priced product → keep Add to Cart -->
        <a
          href="javascript:void(0);"
          class="btn btn--wide btn--buyNow add-to-cart-btn"
          data-variant-id="{{ first_avail.id }}"
          style="background:#e0592a;color:#fff;"
        >
          <span style="display:flex;align-items:center;gap:10px;">
            <i
              class="fa fa-cart"
              style="content:url(https://cdn.shopify.com/s/files/1/0439/5597/8399/files/Asset_Cart-white.png?v=1730169426);height:17px;"
            ></i>
            Add to Cart
          </span>
        </a>
      {% else %}
        <button class="btn btn--wide" disabled>Sold out</button>
      {% endif %}
    {% endif %}
  </div>
</div>

  <style>
    /* Ensure the hover effect only applies to the image container */
    .product-image-wrapper {
      position: relative;
      overflow: hidden;
      width: 100%;
      height: 100%;
      padding-top: 100%; /* Maintain aspect ratio */
    }

    .product-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: none !important;
    }

    /* Default image visible, second image hidden */
    .product-image.front {
      opacity: 1;
      z-index: 2;
    }

    .product-image.back {
      opacity: 0;
      z-index: 100;
      transform: scale(1.04);
    }

    /* Hide default image and show hover image on hover */
    .product-grid-item:hover .product-image-wrapper .product-image.front {
      opacity: 0 !important;
    }

    .product-grid-item:hover .product-image-wrapper .product-image.back {
      opacity: 1 !important;
      transform: scale(1);
      transition: 0.3s ease !important;

    }

    /* Single image stays visible without hover effect */
    .product-image.single {
      opacity: 1;
      z-index: 2;
    }
  </style>

  <style>
  .variant-quick-specs { margin-top: 8px; }
  .vqs-row { display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:10px 14px; }
  @media(min-width:900px){ .vqs-row{ grid-template-columns: repeat(3,minmax(0,1fr)); } }
  .vqs-col small{ display:block; color:#666; font-size:12px; margin-bottom:4px; }
  .vqs-val{ font-size:14px; line-height:1.3; }
  .vqs-compare{ color:#888; font-weight:400; margin-left:6px; }
  .vqs-mats{ display:flex; gap:6px; align-items:center; }
  .material { font-family: 'Humanist777BT-Bold'; border-radius: 5px; color: white; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; }
  .material-P { background:#0069a7 }
  .material-M { background:#f6b519 }
  .material-K { background:#e0592a }
  .material-N { background:#109954 }
  .material-S { background:#f88d2b }
  .material-H { background:#666666 }
</style>
