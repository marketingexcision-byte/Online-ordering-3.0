{% render 'wcp_discount' with product %}
{% assign current_variant = product.selected_or_first_available_variant %}
{% render 'wcp_variant' with current_variant %}

{% assign temp_wcp_v_price = wcp_v_price %}
{% assign temp_wcp_v_compare_at_price = wcp_v_compare_at_price %}
{% unless grid_item_width %}
  {% assign grid_item_width = 'large--one-quarter medium-down--one-half' %}
{% endunless %}

{% unless image_size %}
  {% assign image_size = '600x600' %}
{% endunless %}

{% unless current_collection %}
  {% assign current_collection = collection %}
{% endunless %}

{% assign on_sale = false %}
{% if wcp_compare_at_price > wcp_price %}
  {% assign on_sale = true %}
{% endif %}

<div class="grid-item {{ grid_item_width }}{% if on_sale %} on-sale{% endif %}">
  <a href="{{ product.url | within: current_collection }}"
   class="product-grid-item"
   data-variant-id="{{ current_variant.id }}">
    <div class="product-grid-image">
      <div class="product-grid-image--centered">
        {% if product.tags contains 'New'%}
          <span class="new-badge font-bold">New</span>
        {% endif %}
        {% if product.tags contains 'YG-1' %}
          <div
            class="yg-logo-wrapper"
            style="position: absolute; top: 0; right: 0; z-index: 10; padding: 15px; background: #d52e30; border-radius: 0px 15px;"
          >
            <img
              src="https://cdn.shopify.com/s/files/1/0439/5597/8399/files/YG_Logo_White.png?v=1748387180"
              alt="YG-1 Logo"
              class="yg-logo"
              style="max-width: 50px; height: auto;"
              width="50px"
            >
          </div>
        {% endif %}

        {% if product.featured_image %}
          {% assign first_image = product.featured_image %}

          {% if product.images.size > 1 %}
            {% assign second_image = product.images[1] %}
            <div class="product-image-wrapper">
              <!-- First (Default) Image -->
              <img
                class="product-image front lazyload"
                data-src="{{ first_image | img_url: '540x' }}"
                data-widths="[125, 180, 360, 540, 720, 900, 1080, 1296, 1512, 1728, 2048]"
                data-sizes="auto"
                alt="{{ first_image.alt | escape }}"
              >

              <!-- Second (Hover) Image -->
              <img
                class="product-image back lazyload"
                data-src="{{ second_image | img_url: '540x' }}"
                data-widths="[125, 180, 360, 540, 720, 900, 1080, 1296, 1512, 1728, 2048]"
                data-sizes="auto"
                alt="{{ second_image.alt | escape }}"
              >
            </div>
          {% else %}
            <div class="product-image-wrapper" style="transition: none;">
              <!-- Single Image (No Hover Effect) -->
              <img
                class="product-image single lazyload"
                data-src="{{ first_image | img_url: '540x' }}"
                data-widths="[125, 180, 360, 540, 720, 900, 1080, 1296, 1512, 1728, 2048]"
                data-sizes="auto"
                alt="{{ first_image.alt | escape }}"
              >
            </div>
          {% endif %}
        {% else %}
          <div>
            <img
              class="product-placeholder-image"
              src=" https://cdn.shopify.com/s/files/1/0439/5597/8399/files/Excision_Logo_2025.svg?v=1745463654"
              alt="Excision"
            >
          </div>
        {% endif %}
      </div>
    </div>

    <p class="font-bold {% if product.metafields.custom.title.value != blank %} cpgs_title{% endif %}">
      {{ product.title }}
    </p>

{%- comment -%} Clean ops list for JS hydration {%- endcomment -%}
{%- assign ops_human = '' -%}
{%- for t in product.tags -%}
  {%- assign tdown = t | downcase -%}
  {%- if tdown | starts_with: 'operation_' -%}
    {%- assign nice = t | remove_first: 'Operation_' | replace: '_', ' ' -%}
    {%- assign ops_human = ops_human | append: (ops_human != '' ? ', ' : '') | append: nice -%}
  {%- endif -%}
{%- endfor -%}
<span data-vqs-source="ops" data-ops="{{ ops_human | escape }}" style="display:none;"></span>

    
    <div class="product-item--price">
      <span class="medium--left">
{% if on_sale %}
  <span class="visually-hidden">{{ 'products.general.sale_price' | t }}</span>
{% else %}
  <span class="visually-hidden">{{ 'products.general.regular_price' | t }}</span>
{% endif %}

{%- comment -%} === PRICE BLOCK (INC dominant + small EX) === {%- endcomment -%}
{%- assign is_matrix = false -%}
{%- if product.metafields.custom.price_matrix.value != blank or product.metafields.custom.price_matrix != blank -%}
  {%- assign is_matrix = true -%}
{%- endif -%}

{%- assign taxable  = product.selected_or_first_available_variant.taxable | default: true -%}

{%- if is_matrix -%}
{%- comment -%} Parse minimum price from the matrix text (robust) {%- endcomment -%}
{%- assign raw = product.metafields.custom.price_matrix.value | default: product.metafields.custom.price_matrix -%}
{%- assign text = raw | strip | replace: '\r\n', '\n' | replace: '\r', '\n' -%}
{%- assign lines = text | split: '\n' -%}
{%- assign header = lines.first | default: '' -%}

{%- capture tab %}	{% endcapture %}{% comment %} real tab {% endcomment %}
{%- assign comma_cols = header | split: ',' | size -%}
{%- assign tab_cols   = header | split: tab | size -%}
{%- assign delim = ',' -%}
{%- if tab_cols > comma_cols -%}{%- assign delim = tab -%}{%- endif -%}

{%- assign cols = header | split: delim -%}
{%- assign price_col = -1 -%}
{%- for c in cols -%}
  {%- assign k = c | strip | downcase -%}
  {%- if price_col < 0 -%}
    {%- if k == 'price' or k contains 'web price' or k contains 'price 1+' or k contains 'inc gst' or k contains 'ex gst' or k contains 'price inc' or k contains 'price ex' -%}
      {%- assign price_col = forloop.index0 -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- assign min_price_cents = blank -%}
{%- if price_col >= 0 -%}
  {%- for l in lines offset:1 -%}
    {%- assign parts = l | split: delim -%}
    {%- if parts.size != cols.size -%}{% continue %}{%- endif -%}{% comment %} skip malformed rows {% endcomment %}

    {%- assign rawp = parts[price_col] | default: '' -%}
    {%- assign p = rawp | strip | remove: 'AU$' | remove: '$' | replace: ',', '' -%}
    {%- if p == '' -%}{% continue %}{%- endif -%}{% comment %} empty price cell {% endcomment %}

    {%- assign cents = p | plus: 0 | times: 100 | round -%}
    {%- if cents > 0 -%}
      {%- if min_price_cents == blank or cents < min_price_cents -%}
        {%- assign min_price_cents = cents -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}



  {%- if min_price_cents != blank -%}   {# or: if min_price_cents > 0 #}
    {%- assign from_ex  = min_price_cents -%}
    {%- assign from_inc = min_price_cents -%}
    {%- if taxable -%}
      {%- if shop.taxes_included -%}
        {%- assign from_inc = min_price_cents -%}
        {%- assign from_ex  = min_price_cents | times: 10 | divided_by: 11 -%}
      {%- else -%}
        {%- assign from_ex  = min_price_cents -%}
        {%- assign from_inc = min_price_cents | times: 11 | divided_by: 10 -%}
      {%- endif -%}
    {%- endif -%}

    <span class="ex-price ex-price--stack from-price">
      <strong class="ex-price__inc">
  &nbsp;{{ from_inc | money }}<span class="inc-price__label">INC GST</span>
</strong>
{% if taxable %}
  <div class="ex-price__ex">
    &nbsp;{{ from_ex | money }} <span class="ex-price__label">EX GST</span>
  </div>
{% endif %}

    </span>
{%- else -%}
  {%- comment -%} Fallback if matrix couldn’t be parsed — find lowest non-zero variant price instead of $0 {%- endcomment -%}
  {%- assign safe_min = blank -%}
  {%- for v in product.variants -%}
    {%- if v.price > 0 -%}
      {%- if safe_min == blank or v.price < safe_min -%}{%- assign safe_min = v.price -%}{%- endif -%}
    {%- endif -%}
  {%- endfor -%}
  {%- if safe_min != blank -%}
    {%- assign ex_cents  = safe_min -%}
    {%- assign inc_cents = safe_min -%}
    {%- if taxable -%}
      {%- if shop.taxes_included -%}
        {%- assign ex_cents  = safe_min | times: 10 | divided_by: 11 -%}
      {%- else -%}
        {%- assign inc_cents = safe_min | times: 11 | divided_by: 10 -%}
      {%- endif -%}
    {%- endif -%}
    <span class="ex-price ex-price--stack from-price">
      <strong class="ex-price__inc">
  From&nbsp;{{ inc_cents | money }}<span class="inc-price__label">INC GST</span>
</strong>
{% if taxable %}
  <div class="ex-price__ex">
    From&nbsp;{{ ex_cents | money }} <span class="ex-price__label">EX GST</span>
  </div>
{% endif %}

    </span>
  {%- else -%}
    <span class="ex-price ex-price--stack from-price">
      <strong class="ex-price__inc">Select your blade</strong>
    </span>
  {%- endif -%}
{%- endif -%}


{%- else -%}
  {%- comment -%} Normal products — min/max across variants {%- endcomment -%}
  {%- assign min_price_cents = nil -%}
  {%- assign max_price_cents = nil -%}
  {%- for v in product.variants -%}
    {%- if v.price > 0 -%}
      {%- if min_price_cents == nil or v.price < min_price_cents -%}{%- assign min_price_cents = v.price -%}{%- endif -%}
      {%- if max_price_cents == nil or v.price > max_price_cents -%}{%- assign max_price_cents = v.price -%}{%- endif -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if min_price_cents -%}
    {% assign show_from = false %}
{% if product.variants.size > 1 and min_price_cents != max_price_cents %}
  {% assign show_from = true %}
{% endif %}


    {%- assign ex_cents  = min_price_cents -%}
    {%- assign inc_cents = min_price_cents -%}
    {%- if taxable -%}
      {%- if shop.taxes_included -%}
        {%- assign inc_cents = min_price_cents -%}
        {%- assign ex_cents  = min_price_cents | times: 10 | divided_by: 11 -%}
      {%- else -%}
        {%- assign ex_cents  = min_price_cents -%}
        {%- assign inc_cents = min_price_cents | times: 11 | divided_by: 10 -%}
      {%- endif -%}
    {%- endif -%}

    <span class="ex-price ex-price--stack {%- if show_from -%}from-price{%- endif -%}">
      <strong class="ex-price__inc">
  {%- if show_from -%}From&nbsp;{%- endif -%}{{ inc_cents | money }}<span class="inc-price__label">INC GST</span>
</strong>
{% if taxable %}
  <div class="ex-price__ex">
    {%- if show_from -%}From&nbsp;{%- endif -%}{{ ex_cents | money }} <span class="ex-price__label">EX GST</span>
  </div>
{% endif %}

    </span>
{%- else -%}
  {%- comment -%} No non-zero variant prices → show a request label instead of $0.00 {%- endcomment -%}
  <span class="ex-price ex-price--stack from-price">
    <strong class="ex-price__inc">Pricing available on request</strong>
  </span>
{%- endif -%}
{%- endif -%}

</span>

      <style>
                  .product-item--price small {
                    font-size: 18px;
                  }
                  .product-item--price small:hover {
                    color: black;
                  }
                  div.product-item--price {
                    text-align: left;
                  }
                  .product-item--price span {
                    display: flex;
                    line-height: unset;
                    flex-direction: column;
                  }
                  a:hover {
                    color: unset;
                  }
                  /* default: no footprint */
        .icon-container{
          min-height: 0;
          position: absolute;
        }

        /* show + space only when it actually has element children */
        .icon-container:has(> *){
          position: relative;
        }

        /* fallback for older browsers; may miss whitespace-only nodes */
        .icon-container:empty{ display:none; }
      
        .card-variants {
          margin-bottom: 15px;
        }

        .card-variants-label {
            font-size: 16px !important;
            font-weight: 400 !important;
            color: #666666;
            margin-bottom: 7px !important;
            text-align: start;
        }

        .card-variants-chips {
          display: flex;
          flex-wrap: wrap;
          gap: 9px;
        }

        .variant-chip {
            padding: 8px 12px;
            border: 2px solid #e8e8e8;
            border-radius: 99px;
            white-space: nowrap;
            line-height: 1;
            min-height: 40px;
            align-content: center;
        }

        .variant-chip--more {
            color: #666666;
            border: 2px solid #f1f1f1;
        }
      </style>

      {% if product.selected_or_first_available_variant.available
        and product.selected_or_first_available_variant.unit_price_measurement
      %}
        {% render 'product-unit-price', variant: product.selected_or_first_available_variant %}
      {% endif %}
    </div>

{% render 'auto-discount-note', product: product %}

{%- comment -%} ==== VARIANT QUICK GLANCE (variant-scoped. JS hydrated) ==== {%- endcomment -%}
{%- assign v = product.selected_or_first_available_variant -%}

{%- comment -%} Option indexes. Robust if options are reordered {%- endcomment -%}
{%- assign idx_dia = nil -%}
{%- assign idx_rad = nil -%}
{%- for opt in product.options_with_values -%}
  {%- assign nm = opt.name | strip -%}
  {%- if nm == 'Mill Diameter (mm)' -%}{%- assign idx_dia = forloop.index0 -%}{%- endif -%}
  {%- if nm == 'Corner Radius (mm)' -%}{%- assign idx_rad = forloop.index0 -%}{%- endif -%}
{%- endfor -%}
{%- if idx_dia == nil -%}{%- assign idx_dia = 0 -%}{%- endif -%}

<div class="variant-quick-specs"
     data-product-id="{{ product.id }}"
     data-idx-dia="{{ idx_dia }}"
     data-idx-rad="{{ idx_rad }}">

  <div class="vqs-row">
    <div class="vqs-col vqs-price"  style="display:none;">
      <small>Price</small>
      <div class="vqs-val">
        <span data-vqs="price"></span>
        <s class="vqs-compare" data-vqs="compare" style="display:none;"></s>
      </div>
    </div>

    <div class="vqs-col vqs-sku"    style="display:none;"><small>Product Code</small><div class="vqs-val" data-vqs="sku"></div></div>
    <div class="vqs-col vqs-dia"    style="display:none;"><small>Mill Diameter</small><div class="vqs-val" data-vqs="dia"></div></div>
    <div class="vqs-col vqs-shank"  style="display:none;"><small>Shank Diameter</small><div class="vqs-val" data-vqs="shank"></div></div>
    <div class="vqs-col vqs-radius" style="display:none;"><small>Corner Radius</small><div class="vqs-val" data-vqs="radius"></div></div>
    <div class="vqs-col vqs-loc"    style="display:none;"><small>Length of Cut</small><div class="vqs-val" data-vqs="loc"></div></div>
    <div class="vqs-col vqs-ops"    style="display:none;"><small>Operation</small><div class="vqs-val" data-vqs="ops"></div></div>

    <div class="vqs-col vqs-mats"   style="display:none;">
      <small>Workpiece Materials</small>
      <div class="vqs-val" data-vqs="mats"></div>
    </div>

    <div class="vqs-col vqs-stock"  style="display:none;">
      <small>Stock</small>
      <div class="vqs-val">
        <span class="ex-card-badge" data-vqs="stockBadge"></span>
      </div>
    </div>
  </div>
</div>

{%- comment -%} Per-variant payload for client hydration {%- endcomment -%}
<script type="application/json" class="vmap">
[
  {%- for v in product.variants -%}
  {
    "id": {{ v.id }},
    "sku": {{ v.sku | json }},
    "price": {{ v.price | default: 0 }},
    "compare": {{ v.compare_at_price | default: 0 }},
    "available": {{ v.available | json }},
    "inventory_management": {{ v.inventory_management | json }},
    "inventory_quantity": {{ v.inventory_quantity | default: 0 }},
    "inventory_policy": {{ v.inventory_policy | json }},
    "incoming": {{ v.incoming | json }},
    "next_incoming_date": {{ v.next_incoming_date | date: "%s" | default: 'null' }},
    "options": [{% for o in v.options %}{{ o | json }}{% unless forloop.last %},{% endunless %}{% endfor %}],
    "mf": {
      "shank": {{ v.metafields.filter.shank_diameter_mm | default: v.metafields.filter['shank_diameter_mm'] | json }},
      "loc":   {{ v.metafields.custom.length_of_cut_mm  | default: v.metafields.custom['length_of_cut_mm']  | json }}
    }
  }{% unless forloop.last %},{% endunless %}
  {%- endfor -%}
]
</script>


    {% if section.settings.product_reviews_enable %}
      <span class="shopify-product-reviews-badge" data-id="{{ product.id }}"></span>
    {% endif %}

  </a>

  <div class="payment-buttons payment-buttons--medium form-payment-buttons">
    {% assign first_avail = product.selected_or_first_available_variant | default: product.first_available_variant %}
    {% assign _price_cents = first_avail.price | default: product.price | plus: 0 %}

    {% if product.tags contains 'Custom Length' %}
      <!-- Custom-length products must be configured on the PDP -->
      <a href="{{ product.url }}" class="btn btn--wide btn--buyNow" style="background:#f88d2b;color:#fff;">
        <span style="display:flex;align-items:center;gap:10px;"> Select your blade </span>
      </a>

    {% else %}
      {% if _price_cents == 0 %}
        <!-- $0.00 → send them to PDP to request a quote -->
        <a href="{{ product.url }}" class="btn btn--wide btn--buyNow is-quote" style="background:#f88d2b;color:#fff;">
          <span style="display:flex;align-items:center;gap:10px;"> Request Quote </span>
        </a>
      {% elsif first_avail %}
        <!-- normal priced product → keep Add to Cart -->
        <a
          href="javascript:void(0);"
          class="btn btn--wide btn--buyNow add-to-cart-btn"
          data-variant-id="{{ first_avail.id }}"
          style="background:#e0592a;color:#fff;"
        >
          <span style="display:flex;align-items:center;gap:10px;">
            <i
              class="fa fa-cart"
              style="content:url(https://cdn.shopify.com/s/files/1/0439/5597/8399/files/Asset_Cart-white.png?v=1730169426);height:17px;"
            ></i>
            Add to Cart
          </span>
        </a>
      {% else %}
        <button class="btn btn--wide" disabled>Sold out</button>
      {% endif %}
    {% endif %}
  </div>
</div>

  <style>
    /* Ensure the hover effect only applies to the image container */
    .product-image-wrapper {
      position: relative;
      overflow: hidden;
      width: 100%;
      height: 100%;
      padding-top: 100%; /* Maintain aspect ratio */
    }

    .product-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: none !important;
    }

    /* Default image visible, second image hidden */
    .product-image.front {
      opacity: 1;
      z-index: 2;
    }

    .product-image.back {
      opacity: 0;
      z-index: 100;
      transform: scale(1.04);
    }

    /* Hide default image and show hover image on hover */
    .product-grid-item:hover .product-image-wrapper .product-image.front {
      opacity: 0 !important;
    }

    .product-grid-item:hover .product-image-wrapper .product-image.back {
      opacity: 1 !important;
      transform: scale(1);
      transition: 0.3s ease !important;

    }

    /* Single image stays visible without hover effect */
    .product-image.single {
      opacity: 1;
      z-index: 2;
    }
  </style>

  <style>
  .variant-quick-specs { margin-top: 8px; }
  .vqs-row { display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:10px 14px; }
  @media(min-width:900px){ .vqs-row{ grid-template-columns: repeat(3,minmax(0,1fr)); } }
  .vqs-col small{ display:block; color:#666; font-size:12px; margin-bottom:4px; }
  .vqs-val{ font-size:14px; line-height:1.3; }
  .vqs-compare{ color:#888; font-weight:400; margin-left:6px; }
  .vqs-mats{ display:flex; gap:6px; align-items:center; }
  .material { font-family: 'Humanist777BT-Bold'; border-radius: 5px; color: white; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; }
  .material-P { background:#0069a7 }
  .material-M { background:#f6b519 }
  .material-K { background:#e0592a }
  .material-N { background:#109954 }
  .material-S { background:#f88d2b }
  .material-H { background:#666666 }
</style>
