{%- comment -%}
Reads customer metafields in the `custom` namespace.
Matches against product tags. Picks the highest matching percent.
Falls back to custom.store_wide_discount.
{%- endcomment -%}

{%- assign max_pct = 0 -%}

{%- if customer and product -%}
  {%- comment -%}
  Map of Product Tag -> customer metafield key suffix.
  Left side must match your actual tag text. Right side is the key under custom.*.
  Edit only the left side if your tags differ.
  {%- endcomment -%}
  {%- assign discount_map = 
    "ISO Inserts:insert_discount|
     Taps:taps_discount|
     Drills:drills_discount|
     End Mills:end_mills_discount|
     Coldsaw Machines:coldsaw_machines_discount|
     Punch Dies:punch_dies_discount|
     Core Drills Acc:core_drills_acc_discount|
     Magnetic Drills:magnetic_drills_discount|
     Coolant:coolant_discount|
     TCT Circular Blade:tct_circular_blade_discount|
     Coldsaw Blade:coldsaw_blade_discount|
     Bandsaw Blade:bandsaw_blade_discount|
     Bandsaw Machines:bandsaw_machines_discount" | strip -%}

  {%- assign product_tags_downcased = product.tags | join: "||" | downcase | split: "||" -%}

  {%- for pair in discount_map | split: "|" -%}
    {%- assign parts = pair | split: ":" -%}
    {%- assign tag_label = parts[0] | strip -%}
    {%- assign meta_key  = parts[1] | strip -%}

    {%- assign tag_dc = tag_label | downcase -%}
    {%- if product_tags_downcased contains tag_dc -%}
      {%- assign raw_val = customer.metafields.custom[meta_key] -%}
      {%- assign pct = raw_val | default: 0 | plus: 0 -%}
      {%- if pct > max_pct -%}
        {%- assign max_pct = pct -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}

  {%- assign storewide_raw = customer.metafields.custom.store_wide_discount -%}
  {%- assign storewide_pct = storewide_raw | default: 0 | plus: 0 -%}
  {%- if storewide_pct > max_pct -%}
    {%- assign max_pct = storewide_pct -%}
  {%- endif -%}
{%- endif -%}

{%- if customer and max_pct > 0 -%}
  <div class="auto-discount-note" role="status" aria-live="polite">
    {{ max_pct }}% discount applied at checkout
  </div>
  <style>
    .auto-discount-note {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      padding: 0.5rem 0.625rem;
      border-radius: 6px;
      background: color-mix(in srgb, currentColor 10%, transparent);
    }
  </style>
{%- endif -%}
