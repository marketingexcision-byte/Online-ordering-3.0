{% liquid
  # ---------- Pick the owner that actually has metafields ----------
  assign owner = nil
  if page
    assign owner = page
  elsif product
    assign owner = product
  elsif collection
    assign owner = collection
  elsif article
    assign owner = article
  endif

  # Small helper: an empty array
  assign EMPTY = '' | split: ','

  # ---------- Get raw metafields ----------
  assign fp_meta = nil
  assign ap_meta = nil
  if owner and owner.metafields and owner.metafields.custom
    assign fp_meta = owner.metafields.custom.feature_points
    assign ap_meta = owner.metafields.custom.advantage_points
  endif

  # ---------- Coerce to arrays ----------
  assign fp_items = EMPTY
  if fp_meta
    assign fp_items = fp_meta.value | default: (fp_meta.references | map: 'value') | default: EMPTY
  endif

  assign ap_items = EMPTY
  if ap_meta
    assign ap_items = ap_meta.value | default: (ap_meta.references | map: 'value') | default: EMPTY
  endif

  # ---------- Decide if there is anything worth rendering ----------
  assign show_fp = false
  for obj in fp_items
    assign icon  = obj.feature_point_icon | default: obj.icon | default: obj.image | default: obj.media | default: obj.file
    assign title = obj.feature_point_title | default: obj.title | default: obj.name | default: obj.heading
    assign body  = obj.feature_point_text  | default: obj.text  | default: obj.copy | default: obj.content | default: obj.description
    assign body_rte = body.value | default: body
    if (icon and icon != blank) or (title and title != blank) or (body_rte and body_rte != blank)
      assign show_fp = true
      break
    endif
  endfor

  assign show_ap = false
  for obj in ap_items
    assign icon  = obj.advantage_point_icon | default: obj.icon | default: obj.image | default: obj.media | default: obj.file
    assign title = obj.advantage_point_title | default: obj.title | default: obj.name | default: obj.heading
    assign body  = obj.advantage_point_text  | default: obj.text  | default: obj.copy | default: obj.content | default: obj.description
    assign body_rte = body.value | default: body
    if (icon and icon != blank) or (title and title != blank) or (body_rte and body_rte != blank)
      assign show_ap = true
      break
    endif
  endfor

  assign show_any = show_ap or show_fp

  # ---------- IDs / aria ----------
  assign sid = section.id | default: template.name | default: 'page'
  capture labelledby
    if show_ap and show_fp == false
      echo 'advantages-heading-' | append: sid
    elsif show_fp and show_ap == false
      echo 'features-heading-' | append: sid
    elsif show_ap and show_fp
      echo 'advantages-heading-' | append: sid | append: ' features-heading-' | append: sid
    endif
  endcapture
%}

{% if show_any %}
<section class="section section--feature-points" {% if labelledby != blank %}aria-labelledby="{{ labelledby }}"{% endif %}>
  <div class="container layout-constrained">

    {% if show_ap %}
      <header class="section__header">
        <h2 id="advantages-heading-{{ sid }}" class="section__title text-h3">Advantages</h2>
      </header>
      <div class="ap-grid" role="list">
        {% for obj in ap_items %}
          {% liquid
            assign icon  = obj.advantage_point_icon | default: obj.icon | default: obj.image | default: obj.media | default: obj.file
            assign title = obj.advantage_point_title | default: obj.title | default: obj.name | default: obj.heading
            assign body  = obj.advantage_point_text  | default: obj.text  | default: obj.copy | default: obj.content | default: obj.description
            assign body_rte = body.value | default: body
          %}
          {% if (icon and icon != blank) or (title and title != blank) or (body_rte and body_rte != blank) %}
            <article class="ap-card card" role="listitem">
              <div class="ap-card__icon" aria-hidden="true">
                {% if icon and icon != blank %}
                  {%- assign alt = title | default: 'Advantage icon' -%}
                  {%- capture sizes -%}(min-width: 1024px) 80px, 64px{%- endcapture -%}
                  {{- icon | image_url: width: 160 | image_tag: class: 'ap-card__img', loading: 'lazy', decoding: 'async', widths: '64,80,120,160', sizes: sizes, alt: alt -}}
                {% else %}
                  <svg class="ap-card__svg" viewBox="0 0 40 40" focusable="false" aria-hidden="true">
                    <circle cx="20" cy="20" r="19" class="ap--steel" />
                    <path d="M12 20l5 5 11-11" class="ap--tick" />
                  </svg>
                {% endif %}
              </div>
              {% if title %}<h3 class="ap-card__title text-h4">{{ title }}</h3>{% endif %}
              {% if body_rte %}<div class="ap-card__body text-p1 rte">{{ body_rte }}</div>{% endif %}
            </article>
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}

    {% if show_fp %}
      <header class="section__header">
        <h2 id="features-heading-{{ sid }}" class="section__title text-h3">Features</h2>
      </header>
      <div class="fp-grid" role="list">
        {% for obj in fp_items %}
          {% liquid
            assign icon  = obj.feature_point_icon | default: obj.icon | default: obj.image | default: obj.media | default: obj.file
            assign title = obj.feature_point_title | default: obj.title | default: obj.name | default: obj.heading
            assign body  = obj.feature_point_text  | default: obj.text  | default: obj.copy | default: obj.content | default: obj.description
            assign body_rte = body.value | default: body
          %}
          {% if (icon and icon != blank) or (title and title != blank) or (body_rte and body_rte != blank) %}
            <article class="fp-card card" role="listitem">
              <div class="fp-card__icon" aria-hidden="true">
                {% if icon and icon != blank %}
                  {%- assign alt = title | default: 'Feature icon' -%}
                  {%- capture sizes -%}(min-width: 1024px) 80px, 64px{%- endcapture -%}
                  {{- icon | image_url: width: 160 | image_tag: class: 'fp-card__img', loading: 'lazy', decoding: 'async', widths: '64,80,120,160', sizes: sizes, alt: alt -}}
                {% else %}
                  <svg class="fp-card__svg" viewBox="0 0 40 40" focusable="false" aria-hidden="true">
                    <circle cx="20" cy="20" r="19" class="fp--bronze" />
                    <path d="M20 10v20M10 20h20" class="fp--plus" />
                  </svg>
                {% endif %}
              </div>
              {% if title %}<h3 class="fp-card__title text-h4">{{ title }}</h3>{% endif %}
              {% if body_rte %}<div class="fp-card__body text-p1 rte">{{ body_rte }}</div>{% endif %}
            </article>
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}

  </div>
</section>
{% endif %}
