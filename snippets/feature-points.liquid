{% liquid
  # ---------- SOURCE ----------
  assign fp_items = blank
  assign ap_items = blank

  if page and page.metafields and page.metafields.custom
    assign fp_meta = page.metafields.custom.feature_points
    if fp_meta
      if fp_meta.value and fp_meta.value != blank
        assign fp_items = fp_meta.value
      elsif fp_meta.references and fp_meta.references != blank
        assign fp_items = fp_meta.references | map: 'value'
      endif
    endif

    assign ap_meta = page.metafields.custom.advantage_points
    if ap_meta
      if ap_meta.value and ap_meta.value != blank
        assign ap_items = ap_meta.value
      elsif ap_meta.references and ap_meta.references != blank
        assign ap_items = ap_meta.references | map: 'value'
      endif
    endif
  endif

  # Ensure arrays & strip nils
  assign EMPTY = '' | split: ','
  assign fp_items = fp_items | default: EMPTY | compact
  assign ap_items = ap_items | default: EMPTY | compact
%}

{%- capture ap_cards -%}
  {%- for obj in ap_items -%}
    {%- liquid
      assign icon  = obj.advantage_point_icon  | default: obj.icon | default: obj.image | default: obj.media | default: obj.file
      assign title = obj.advantage_point_title | default: obj.title | default: obj.name | default: obj.heading
      assign body  = obj.advantage_point_text  | default: obj.text  | default: obj.copy | default: obj.content | default: obj.description
      assign title_out = title.value | default: title
      assign body_out  = body.value  | default: body
    -%}
    {%- if (icon and icon != blank) or (title_out and title_out != blank) or (body_out and body_out != blank) -%}
      <article class="ap-card card" role="listitem">
        <div class="ap-card__icon" aria-hidden="true">
          {%- if icon and icon != blank -%}
            {%- assign alt = title_out | default: 'Advantage icon' -%}
            {%- capture sizes -%}(min-width: 1024px) 80px, 64px{%- endcapture -%}
            {{- icon | image_url: width: 160 | image_tag: class: 'ap-card__img', loading: 'lazy', decoding: 'async', widths: '64,80,120,160', sizes: sizes, alt: alt -}}
          {%- endif -%}
        </div>
        {%- if title_out -%}<h3 class="ap-card__title text-h4">{{ title_out }}</h3>{%- endif -%}
        {%- if body_out  -%}<div class="ap-card__body text-p1 rte">{{ body_out }}</div>{%- endif -%}
      </article>
    {%- endif -%}
  {%- endfor -%}
{%- endcapture -%}

{%- capture fp_cards -%}
  {%- for obj in fp_items -%}
    {%- liquid
      assign icon  = obj.feature_point_icon | default: obj.icon | default: obj.image | default: obj.media | default: obj.file
      assign title = obj.feature_point_title | default: obj.title | default: obj.name | default: obj.heading
      assign body  = obj.feature_point_text | default: obj.text  | default: obj.copy | default: obj.content | default: obj.description
      assign title_out = title.value | default: title
      assign body_out  = body.value  | default: body
    -%}
    {%- if (icon and icon != blank) or (title_out and title_out != blank) or (body_out and body_out != blank) -%}
      <article class="fp-card card" role="listitem">
        <div class="fp-card__icon" aria-hidden="true">
          {%- if icon and icon != blank -%}
            {%- assign alt = title_out | default: 'Feature icon' -%}
            {%- capture sizes -%}(min-width: 1024px) 80px, 64px{%- endcapture -%}
            {{- icon | image_url: width: 160 | image_tag: class: 'fp-card__img', loading: 'lazy', decoding: 'async', widths: '64,80,120,160', sizes: sizes, alt: alt -}}
          {%- endif -%}
        </div>
        {%- if title_out -%}<h3 class="fp-card__title text-h4">{{ title_out }}</h3>{%- endif -%}
        {%- if body_out  -%}<div class="fp-card__body text-p1 rte">{{ body_out }}</div>{%- endif -%}
      </article>
    {%- endif -%}
  {%- endfor -%}
{%- endcapture -%}

{%- assign have_ap = ap_cards | strip -%}
{%- assign have_fp = fp_cards | strip -%}

{%- if have_ap != '' or have_fp != '' -%}
  {%- assign sid = section.id | default: template.name | default: 'page' -%}
  {%- capture labelledby -%}
    {%- if have_ap != '' and have_fp == '' -%}advantages-heading-{{ sid }}{%- endif -%}
    {%- if have_fp != '' and have_ap == '' -%}features-heading-{{ sid }}{%- endif -%}
    {%- if have_ap != '' and have_fp != '' -%}advantages-heading-{{ sid }} features-heading-{{ sid }}{%- endif -%}
  {%- endcapture -%}

  <section class="section section--feature-points" {% if labelledby != blank %}aria-labelledby="{{ labelledby }}"{% endif %}>
    <div class="container layout-constrained">

      {%- if have_ap != '' -%}
        <header class="section__header">
          <h2 id="advantages-heading-{{ sid }}" class="section__title text-h3">Advantages</h2>
        </header>
        <div class="ap-grid" role="list">
          {{ ap_cards }}
        </div>
      {%- endif -%}

      {%- if have_fp != '' -%}
        <header class="section__header">
          <h2 id="features-heading-{{ sid }}" class="section__title text-h3">Features</h2>
        </header>
        <div class="fp-grid" role="list">
          {{ fp_cards }}
        </div>
      {%- endif -%}

    </div>
  </section>
{%- endif -%}
